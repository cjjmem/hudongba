// JavaScript Document WAP端详情页
var _detailApi3 = {
  _sendCode: "/post/api:66",
  _verifyCode: "/post/api:67",
  _care: "/post/api:77",
  _template: "/post/api:78"
};
/*滚动位置设置*/
var _scroollTop = {
  _top: function(id, delay, move) {
    var scroll_offset = $(id).offset();
    if (null != scroll_offset) {
      setTimeout(function() {
        var scroll_offset = $(id).offset();
        $("body,html").animate({
          scrollTop: scroll_offset.top
        }, move);
      }, delay);
    }
  }
};

/*管理*/
var _manage = {
  _init: function() {
    if (_user._inHudongba()) {
      return;
    }
    if (_user._login() && _user._id() == _info._postUid) {
      $("#dt_list_title_manage").bind("click", function(e) {
        _manage._installApp(true);
        e.stopPropagation();
      });
      $("#dt_list_title_manage").show();
    }
  },
  _installApp: function(install) {
    if (!install && _user._isappinstalled()) {
      return;
    }
    _alert._show("下载互动吧，管理报名信息", "<p style='text-align:left;padding:0 10px;'>1. 添加更多报名项目，设置报名费用和报名人数<br />2. 添加图片和视频，编辑字体颜色、大小<br />3. 发布后管理报名人员，收集报名信息</p>", "一键安装App", function() {
      _download(_link._appDownload);
    }, "关闭提示");
  },
  _installApp2: function(install) {
    if (!install && _user._isappinstalled()) {
      return;
    }
    _alert._show("下载互动吧，管理投票信息", "<p style='text-align:left;padding:0 10px;'>1. 设置投票多选项数，更改匿名或实名投票方式<br />2. 即时收取投票、评论通知，随时关注投票进展<br />3. 添加图片和表情，编辑字体颜色、尺寸</p>", "一键安装App", function() {
      _download(_link._appDownload);
    }, "关闭提示");
  },
  _installApp3: function(install) {
    if (!install && _user._isappinstalled()) {
      return;
    }
    _alert._show("下载互动吧，管理文章信息", "<p style='text-align:left;padding:0 10px;'>1. 即时收取评论通知，随时了解文章关注度<br />2. 添加图片和表情，编辑字体颜色、尺寸<br />3. 其他高级发布功能，更多特色玩法</p>", "一键安装App", function() {
      _download(_link._appDownload);
    }, "关闭提示");
  }
};

var _guess = {
  _size: 20,
  _isDelay: true,
  _indexStr: "",
  _index: 1,
  _infoMsg: {
    party: "报名",
    article: "查看",
    job: "查看",
    recruit: "报名",
    vote: "投票",
    welfare: "参与"
  },
  _top: function() {
    if (_user._inHudongba()) {
      $(".dt_guess_topR a").attr("href", "javascript:void(0)");
      $(".dt_guess_topR a").bind("click", function() {
        HudongbaJsBridge["showFindPanel"]();
      });
    }
    _$(_api3._guess, "location=2&index_str=" + _guess._indexStr + "&page_num=1&page_size=6&welfare_type=purchase&info_type=" + _info._type + "&info_id=" + _info._id, _guess._ok);
  },
  _ok: function(json, code) {
    if (json != null) {
      _guess._indexStr = json.index_str;
      var _hot = json.hotArray;
      var _len = _hot.length;
      _guess._index++;
      if (_len == 0) {
        return;
      }
      var _next = _hot[_len - 1];
      var _html = "";
      var _welare = json.welfare;
      for (var i = 0, _len = _welare.length; i < _len; i++) {
        _welare[i].title = _welare[i].nick_name + _welare[i].title;
        _html += _guess._addItem(_welare[i]);
      }
      var _pSize = 0;
      for (var i = 0; _pSize < 4 && i < _hot.length; i++) {
        var _d = _hot[i];
        if (!(_info._id == _d.infoId && _info._type == _d.infoType)) {
          _html += _guess._addItem(_d);
          _pSize++;
        }
      }
      var thisNext = _info._type.replace(_info._type, function($1) {
        return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
      });
      $("#dt_guess_list_main").append(_html);
      $("#dt_join_bar_menu").attr("href", "/" + _next.infoType + "/" + _next.infoId + "?hdb_from=Wap" + thisNext + "Next");
      _guess._reset();
    }
  },
  _addItem: function(item) {
    var _html = "<li ontouchstart=''><a ontouchstart='' href=\"/" + item.infoType + "/" + item.infoId + "-DInteraction.html\" class=\"dt_guess_list " + item.infoType + "\">" + "<div class=\"dt_guess_list_icon\"><span></span></div>" + "<div class=\"dt_guess_list_title dt_loadNew2\"><span class=\"font03\">" + item.title + "</span></div>" + "<p class=\"dt_guess_list_num font04\">" + item.hits + _guess._infoMsg[item.infoType] + "</p>" + "</a></li>";
    return _html;
  },
  _init: function() {
    _guess._top();
    if (_user._inHudongba()) {
      $("#ba_Bj").hide();
      $(".content-body").css({"border-bottom-color": "#efeff4","border-bottom-style": "solid","border-bottom-width": 72 + "px"});
    }
  },
  _trigger: function() {
    if (!_cover._flag && !_guess._flag && _guess._index <= 4 && ($("#dt_join_bar").offset().top + $("#dt_join_bar").height() + 5) > $(document).height()) {
      _guess._list();
    }
    _useCare._initFirst();
  },
  _list: function() {
    if (_guess._flag == true) {
      return;
    }
    _guess._flag = true;
    _guess._size = 20;
    if (_guess._index == 1) {
      _guess._flag = false;
      return;
    }
    if (_guess._index == 2) {
      _guess._size = 6;
    } else if (_guess._index == 3) {
      _guess._size = 10;
    }
    _bottomLoading._loading("guess_loading", "正在加载...");
    _$(_api3._guess, "location=2&index_str=" + _guess._indexStr + "&page_num=" + _guess._index + "&page_size=" + (_guess._size + 1), _guess._listOk);
  },
  _listOk: function(json, code) {
    if (!_user._inHudongba()) {
      _bottomLoading._hide("guess_loading");
    }
    var _state = json.state;
    if (code != 200 || (code == 200 && _state != "0")) {
      _bottomLoading._more("guess_loading", "网络错误，点击重新加载", _guess._list);
      return;
    }
    var _data = json.hotArray,
      _len = _data.length;
    _guess._indexStr = json.index_str;
    if (json.next_sate.toString() == "0" || _guess._index == 4) {
      $(window).unbind("scroll");
      if (_user._inHudongba()) {
        $("#dt_guess").css({"margin-bottom": "0px"});
        $("#moreXinxi").css({"margin-bottom": "70px"});
      }
      $("#moreXinxi").show();
      _bottomLoading._hide("guess_loading");
    } else {
      _guess._flag = false;
      _guess._index++;
    }
    if (_len == 0) {
      return;
    }
    var _html = "";
    var _pSize = 0;
    for (var i = 0; _pSize < _guess._size && i < _len; i++) {
      var _d = _data[i];
      if (!(_info._id == _d.infoId && _info._type == _d.infoType)) {
        _html += _guess._addItem(_d);
        _pSize++;
      }
    }
    $("#dt_guess_list_main").append(_html);
    _guess._reset();
  },
  _reset: function() {
    $(".dt_loadNew").each(function() {
      $(this).css("max-width", ($(".dt_guess").width() - 68) - $(this).next("p").width() + "px");
    });
    $(".dt_loadNew2").each(function() {
      $(this).css("width", ($(".dt_guess").width() - 60) - $(this).next("p").width() + "px");
    });
  }
};

/* 加载详情页推荐数据 */
var _recommend = {

  _init: function() {
    _$(_api3._recommend, "info_type=" + _info._type + "&info_id=" + _info._id, _recommend._ok);
  },
  _ok: function(json, code) {
    if (code == 200) {
      var system = json.system;
      var next = json.next;
      //加载同类推荐数据
      var recommendList = json.recommendList;
      var recommendLength = 0;
      if (recommendList != undefined) {
        recommendLength = recommendList.length;
      }
      if (recommendLength > 0) {
        var recommendHtml = "<div class='dt_guess'><ul class='dt_guess_list_main'>";
        for (var index = 0; index < recommendLength; index++) {
          var recommendItem = recommendList[index];
          recommendHtml += "<li><a class='dt_guess_list party' href='/party/" + recommendItem.infoId36 + "-DInteraction.html?" + _HDB_POS_KEY + "=info_rec'>";
          recommendHtml += "<div class='dt_guess_list_icon'><span></span></div>";
          recommendHtml += "<div class='dt_guess_list_title dt_loadNew'><span>" + recommendItem.infoTitle + "</span></div>";
          recommendHtml += "<p class='dt_guess_list_num'>" + recommendItem.join + "报名</p></a></li>";
        }
        recommendHtml += "</ul></div>";
        $("#sameKindRecommend").after(recommendHtml);
      } else {
        //隐藏同类推荐title
        $("#sameKindRecommend").hide();
      }
      //加载精品推荐数据
      var hotList = json.hotList;
      var hotLength = 0;
      if (hotList != undefined) {
        hotLength = hotList.length;
      }
      if (hotLength > 0) {
        var hotHtml = "<div class='dt_guess dt_guess2' id='jxhd'><ul class='dt_guess_list_main'>";
        for (var index = 0; index < hotLength; index++) {
          if (recommendLength > 0 && index >= 3) {
            break;
          }
          var hotItem = hotList[index];
          if(hotItem.imageUrl=="" || hotItem.imageUrl=="http://img1.hudongba.com" || hotItem.imageUrl=="http://img2.hudongba.cn"){
        	  var _hotImage = _imgCdn + "/static_v4/images/other/face_default_105.png";
          }else{
        	  var _hotImage = hotItem.imageUrl;
          }
          hotHtml += "<li><a class='dt_guess_list party' href='/party/" + hotItem.infoId36 + "-DInteraction.html?" + _HDB_POS_KEY + "=info_rec'>";
          //加数据
          hotHtml += "<div class='dt_guess_list_icon'><img alt='' src='"+_hotImage+"' onerror='this.src=\"http://img1.hudongba.com/static_v4/images/other/face_default_200.png\"'></div>";
          hotHtml += "<div class='dt_guess_list_title'><span>" + hotItem.infoTitle + "</span></div>";
            if(hotItem.infoStartTime && hotItem.infoStartTime != undefined){
                hotHtml += "<div class='find_main_time'><img alt='' src='"+_imgCdn+"/static_v4/images/detail/icon_time.png'><p>"+hotItem.infoStartTime+"</p></div>";
            }
            if(hotItem.infoLocation && hotItem.infoLocation != undefined){
                hotHtml += "<div class='find_main_address'><img alt='' src='"+_imgCdn+"/static_v4/images/detail/icon_addr.png'><p class='dt_guess_list_attr'>"+hotItem.infoLocation+"</p><p class='dt_guess_list_num'><span>" + hotItem.join + "</span> 报名</p></div>";
            }else{
            	hotHtml += "<div class='find_main_address'><p class='dt_guess_list_num'><span>" + hotItem.join + "</span> 报名</p></div>";
            }
          hotHtml += "</a></li>";
        }
        hotHtml += "</ul></div>";
        $("#hotRecommend").after(hotHtml);
        $(".find_main_address").each(function(){
        	var w = $("body").width();
        	var m = $(this).find(".dt_guess_list_num").width();
        	$(this).find(".dt_guess_list_attr").css("max-width",w-m-113+"px");
        });
      } else {
        //隐藏精品推荐title
        $("#hotRecommend").hide();
      }
      //下一篇
      if(next != undefined){
          $("#dt_join_bar_menu").attr("href", "/" + next.infoType + "/" + next.infoId36);
      }

    }
  }
};

/*已报名的弹框**/
var _joinBar = {
  _id: "",
  _center: function() {
    var w = $("body").width();
    var _left;
    if (w > 1000) {
      _left = (w - 1000) / 2 + "px";
    } else {
      _left = 0 + "px";
    }
    $("#dt_join_bar_list").css({"left": _left,"bottom": "0px","z-index": "3000","position": "fixed"});
  },
  _show: function(id) {
    _joinBar._id = id;
    _cover._show("cover2");
    _joinBar._center();
    $("#dt_join_bar_list").slideDown(500);
    $(window).bind("resize", _joinBar._center);
    $("#cover2").bind("click", _joinBar._hide);
  },
  _cancel: function() {
    _joinBar._hide();
    _joinAfter._id = "cancel_ok";
    _joinAfter._show("cancel_ok");
  },
  _cancelYes: function() {
    _$(_api3._joinCancel, "info_id=" + _info._id + "&info_type=" + _info._type, _joinBar._cancelOk);
  },
  _cancelOk: function(json, code) {
    if (code != 200) {
      return;
    }
    _payList._add();
    var _join = parseInt($("#join_total").html()) - 1;
    if (_join == 0) {
      $("#dt_join_count").html("还没有人报名");
      $("#join_loading").hide();
    } else {
      $("#join_total").html(_join);
    }
    $("#detail_Joinnum .detail_Joinnum_t span").html(_join);
    $("#div_join_id_" + json.joinId).remove();
    _joinAfter._hide();
    _joinBar._hide();
    _scroollTop._top(".dt_join_menu_bg", 500, 200);
    _sucess._show("取消成功");
    if (_info._state == "3" || _info._state == "4" || _info._state == "5") {
      $("#dt_join_bar_title").html("<a ontouchstart=\"\" href=\"javascript:void(0);\" class=\"zTai03\">报名已关闭</a>");
      $("#dt_join_bar_title_mb").html("<a href=\"javascript:void(0)\" ontouchstart=\"\" class=\"btn_style3\"> <p class=\"bar_img\"><span><img class=\"dt_join_bar_icon\" src=\"" + _info._img1Url + "/static_v4/images/detail/icon_man2.png\" alt=\"\" /></span></p> <p class=\"bar_tit\"><span>报名已关闭</span></p></a>");
    } else {
      $("#dt_join_bar_title").html("<a onclick=\"_payItemBox._show('" + _info._type + "')\" class=\"zTai01\" href=\"javascript:void(0);\" ontouchstart=\"\">我要报名</a>");
      $("#dt_join_bar_title_mb").html("<a href=\"javascript:void(0)\" ontouchstart=\"\" onclick=\"_payItemBox._show('${type}')\"> <p class=\"bar_img\"><span><img class=\"dt_join_bar_icon\" src=\"" + _info._img1Url + "/static_v4/images/detail/icon_man2.png\" alt=\"\" /></span></p> <p class=\"bar_tit\"><span>我要报名</span></p></a>");
    }
    if(_info._joinPayItemId!=""&&_info._joinPayItemId!="0"){//有收费项时的取消报名：名额控制
      _info._joinPayItemId = _info._joinPayItemId.replace(/,/g, '');
      if($("#detail_pay_list_li_"+_info._joinPayItemId).find(".detail_pay_list_b").html()=="已卖完"){
    	$("#detail_pay_list_li_"+_info._joinPayItemId).find(".joinNum").html('剩余<b>1</b>');
    	$("#li_pay_item_"+_info._joinPayItemId).find(".detail_pay_list_b").html('剩余<span class="num">1</span>个名额');
      }else if($("#detail_pay_list_li_"+_info._joinPayItemId).find(".detail_pay_list_b").children(".num").length!="0"){
    	$("#detail_pay_list_li_"+_info._joinPayItemId).find(".detail_pay_list_b").children(".num").html(parseInt($("#detail_pay_list_li_"+_info._joinPayItemId).find(".detail_pay_list_b").children(".num").html())+1);
    	$("#li_pay_item_"+_info._joinPayItemId).find(".joinNum").children("b").html(parseInt($("#li_pay_item_"+_info._joinPayItemId).find(".joinNum").children("b").html())+1);
      }
    }
  },
  _joinqQr: function() {
    _joinBar._hide();
    _joinQr._show();
  },
  _hide: function() {
    $("#dt_join_bar_list").slideUp(500);
    _cover._hide("cover2");
  }
};

/*点击报名后*/
var _joinAfter = {
  _id: "",
  _center: function() {
    var _top = _._zero(_._client().bh - $("#" + _joinAfter._id).outerHeight()) / 2 + "px";
    var _left = _._zero(_._client().bw - $("#" + _joinAfter._id).outerWidth()) / 2 + "px";
    $("#" + _joinAfter._id).css({"left": _left,"bottom": _top,"z-index": "3000","position": "fixed"});
  },
  _show: function(joinId) {
    if (joinId == "tc_chengNopay") {
      var _post = "发布投票";
      if (_info._type == "party") {
        _post = "发布活动";
      } else if (_info._type == "recruit") {
        _post = "发布招募";
      }
      $(".yediMore_l a").html(_post);
      if (_user._inHudongba()) {
        $(".yediMore_r a,.yediMore_l a").attr("href", "javascript:void(0)");
        $(".yediMore_r a").bind("click", function() {
          HudongbaJsBridge["showFindPanel"]();
        });
        $(".yediMore_l a").bind("click", function() {
          HudongbaJsBridge["showPostPanel"]();
        });
      }
    }
    _cover._show("cover2");
    _joinAfter._id = joinId;
    _joinAfter._center();
    $("#" + joinId).show();
    $("#cover2").bind("click", _joinAfter._hide);
    if (joinId == "tc_payQuestion") {
      $("#cover2").unbind("click");
    }
    $(window).bind("resize", _joinAfter._center);
  },
  _hide: function() {
    _cover._hide("cover2");
    $("#" + _joinAfter._id).hide();
    _guess._trigger();
  },
  _joinAfterQr: function() {
    _joinAfter._hide();
    _joinQr._show();
  },
  _share: function() {
    _joinAfter._hide();
    _cover._show("cover2");
    _share._joinSucess();
  },
  _payAfter: function() {
    _joinAfter._hide();
    _sucess._show('报名成功');
  },
  _payQuestion: function() {
    _joinAfter._hide();
    _joinAfter._show('tc_noSuccess');
  },
  _paidSucces: function(orderId) {
    _g(_link._checkOrder + "?order_id=" + orderId);
  },
  _checkPayOrder: function() {
    var orderId = $("#orderId").val();
    _$(_api3._checkPayOrder, "order_id=" + orderId + "&info_id=" + _info._id + "&info_type=" + _info._type, _joinAfter._checkOrderOk);
  },
  _checkOrderOk: function(json, code) {
    if (code != 200) {
      return;
    };
    //支付成功
    if (json.payState == "0") {
      _joinAfter._payAfter();
    } else {
      _joinAfter._payQuestion();
      $("#orderId").val(json.orderId);
    }
    if (_user._inHudongba()) {
        var _url = _api3._joinQr + "?user_id=" + _user._id() + "&info_id=" + _info._id + "&info_type=" + _info._type;
        $("#join_qr_img,#join_qr_img8").attr("src", _url);
        $("#join_qr_img,#join_qr_img8").bind("error", function() {
          if ($("#tc_2weima").css("display") == "none") {
            return;
          }
          _joinQr._hide();
          _toast._show("网络错误，请稍后重试");
        });
      }
  },
  _repeat: function() {
    $("#form_order_repeat").attr("action", _link._alipay + "?order_id=" + $("#orderId").val());
  },
  _look: function() {
    _joinAfter._hide('tc_chengNopay');
    _scroollTop._top(".dt_join_menu_bg", 500, 200);
  },
  _look2: function() {
    _joinAfter._hide('tc_chengNopay');
    _scroollTop._top("#dt_vote", 500, 200);
  },
  _goJoinQrPage : function(){
      if(_user._inHudongba() && _info._appVersion != "" && parseFloat(_info._appVersion) >= 5.1){

            HudongbaJsBridge['goJoinQr'](_info._id, _info._type, _info._title);

      }else{
          _g("/pay/paysuccess?infoId=" + _info._id);
      }
  }
};

var _joinBeforeLogin = {
  _mark: function(value) {
    _t._set("join_before_login_" + _info._type + "_" + _info._id, value);
  },
  _continue: function() {
    if (_t._get("join_before_login_" + _info._type + "_" + _info._id) != "") {
      if (_info._join != 0) {
        _joinBeforeLogin._mark("");
        _backToRefresh._mark("");
        return;
      }
      if (!_user._login()) {
        _joinBeforeLogin._mark("");
        _backToRefresh._mark("");
        return;
      }
      var _mobile = _payItemBox._getTemp("party_pay_item_id_2");
      _joinForm._price = 0;
      if (_payItemBox._getTemp(_joinForm._id + "_pay_item_id") != "") {
        _joinForm._price = /\d*(\.)?\d*/.exec($("#li_pay_item_" + _payItemBox._getTemp(_joinForm._id + "_pay_item_id") + " .feiyong_r").html())[0];
      }
      _payItemBox._id = _joinForm._id;
      _payItemBox._init();
      if (_joinForm._price == 0){
        _joinBox._id = _joinForm._id;
        _joinBox._initProperty();
        if (_joinForm._toVerifyMobile(_mobile)) {
          $("#hide_verify_mobile").val("1");
          _joinForm._next();
          return;
        }
        _joinForm._post(_joinForm._id);
      }
    }
  }
};

/**报名*/
var _joinForm = {
  _mobile: "",
  _price: 0,
  _id: "",
  _post: function(id) {
    _joinForm._id = id;
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _hideMobile = $("#hide_verify_mobile").val();
    var _payItemId = "";
    if ($(".tc_c_feiLi li[class='able thisOver']").length > 0) {
      _payItemId = $(".tc_c_feiLi li[class='able thisOver']").attr("payitemid");
    }
    if (_payItemId == "" && _info._payItemId != undefined && _info._payItemId != "") {
      _payItemId = _info._payItemId;
    }
    if (_joinForm._checkProperty()) {
      return false;
    }
    var _mobile = "";
    if ($("#input_pro_id_2").attr("id") != undefined) {
      _mobile = _._trim($("#input_pro_id_2").val());
      _joinForm._mobile = _mobile;
    }
    var _enrollOption = _joinForm._getPorpertyValue();
    var _nick = _._trim($("#input_pro_id_1").val());
    /*不需要支付*/
    if ($(".tc_c_feiLi li[class='able thisOver']").length > 0) {
      _joinForm._price = /\d*(\.)?\d*/.exec($(".tc_c_feiLi li[class='able thisOver'] .feiyong_r").html())[0];
    }
    if (!_user._login()) {
      if (!_user._inHudongba()) {
        _joinBeforeLogin._mark("1");
      }
      _user._toLogin(_thisNext);
      return false;
    }
    if (_hideMobile == "1") {
      $("#hide_verify_mobile").val("0");
      var _formYes = _joinForm._phone(_payItemId, _enrollOption, _nick, _mobile);
      if (!_formYes) {
        $("#hide_verify_mobile").val("1");
        return false;
      }
    } else {
      if (_joinForm._toVerifyMobile(_mobile)) {
        $("#hide_verify_mobile").val("1");
        _joinForm._next();
        return false;
      }
      _loading._show("加载中");
      _joinForm._dataPost(_payItemId, _enrollOption, _nick, _mobile);
    }
  },
  _toVerifyMobile: function(mobile) {
    if (_info._mobileVerify == "1" && mobile != "" && ("|" + _info._verifyMobile).indexOf("|" + mobile + "|") == -1) {
      return true;
    }
    return false;
  },
  _ok: function(json, code) {
    _loading._hide();
    var _oid = "0";
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    if (code == 200) {
      _oid = json.pay.orderId;
    }
    //不需支付
    if (_oid == "0") {
      //报名失败
      if (code != 200) {
        _toast._show("报名失败");
      } else {
        //新页面报名成功 需要跳回详情页-4.1
        if (_info._inNewPage != undefined && _info._inNewPage == "1") {
          var url = "/" + _info._type + "/" + _info._id;
          _t._set(_info._id + "_" + _user._id() + "_joinSuccess", "1");
          var _item = _joinLoading._addItem(json.user_join.join_user_id, json.user_join.big_name, json.user_join.user_pic, json.user_join.date, json.user_join.join_id);
          _t._set(_info._id + "_" + _user._id() + "_item", _item);
          _loading._show();
          setTimeout(function() {
            _g(url);
          }, 100);
          return false;
        }
        dataForShare.title = "我报名了《" + dataForShare.title + "》，你也来看看吧"; //2015.06.24 邀请码功能已不再使用
        $("#dt_join_bar_title").html("<a class=\"zTai02\" href=\"javascript:void(0);\" ontouchstart\"\" onclick=\"_joinBar._show()\">已报名</a>");
        $("#dt_join_bar_title_mb").html("<a href=\"javascript:void(0)\" ontouchstart=\"\" onclick=\"_joinBar._show('${type}')\" class=\"btn_style2\"><p class=\"bar_img\"><span><img class=\"dt_join_bar_icon\" src=\"" + _info._img1Url + "/static_v4/images/detail/icon_man2.png\" alt=\"\" /></span></p> <p class=\"bar_tit\"><span>已报名</span></p></a>");
        if ($("#join_total").attr("id") == undefined) {
          $("#dt_join_count").html("已有<span id=\"join_total\">1</span>人报名");
          $("#dt_list_main").show();
        } else {
          $("#join_total").html(parseInt($("#join_total").html()) + 1);
        }
        $("#detail_Joinnum .detail_Joinnum_t span").html(parseInt($("#detail_Joinnum .detail_Joinnum_t span").html()) + 1);
        var _item = _joinLoading._addItem(json.user_join.join_user_id, json.user_join.big_name, json.user_join.user_pic, json.user_join.date, json.user_join.join_id);
        $("#dt_list_main").html(_item + $("#dt_list_main").html());
        $("#dt_join_menu_bg .dt_join_top").unbind("click");
        _joinBeforeLogin._mark("");
        _joinBox._hide();
        _backToRefresh._mark();
        _joinBox._clear();
        _scroollTop._top(".dt_join_menu_bg", 500, 200);
        _joinAfter._show("tc_chengNopay");
        if (_user._inHudongba()) {
          var _url = _api3._joinQr + "?user_id=" + _user._id() + "&info_id=" + _info._id + "&info_type=" + _info._type;
          $("#join_qr_img,#join_qr_img8").attr("src", _url);
          $("#join_qr_img,#join_qr_img8").bind("error", function() {
            if ($("#tc_2weima").css("display") == "none") {
              return;
            }
            _joinQr._hide();
            _toast._show("网络错误，请稍后重试");
          });
        }
        if (_info._verify == "0") {
          if (_user._inWeixin()) {
            onBridgeReady_new();
          }
        }
        if (_joinForm._toVerifyMobile(_joinForm._mobile)) {
          _info._verifyMobile = _info._verifyMobile + _joinForm._mobile + "|";
        }
        _payList._less();
      }
      $("#a_post").attr("href", "/post?hdb_from=WapEnroll" + _thisNext);
    } else { //需要支付
      if (code == 200) {
        _payItemBox._payOrderId = json.pay.orderId;
        $("#submit_ljA span").html("¥"+json.pay.orderMoney);
        _payList._less();
        _joinBox._hide();
        _joinBeforeLogin._mark("");
        _backToRefresh._mark();
        _joinBox._clear();
        _tc._show("payLock");
        var myhref = window.location.href;
        if (myhref.indexOf('joinParty') != -1) {
          $("#cover2").unbind("click");
        };
          $("#dt_join_bar_title_mb a").attr("onclick", "");
        if (_user._inHudongba()) {
          $("#submit_ljA,#dt_join_bar_title_mb a").bind("click", function() {
            HudongbaJsBridge["getPayPage"](_oid);
          });
          $('#dt_join_bar_title_mb a .bar_tit span').text('去支付');
        } else {
          $("#submit_ljA,#submit_cxA,#dt_join_bar_title_mb a").attr("href", _link._alipay + "?order_id=" + _payItemBox._payOrderId);
          $('#dt_join_bar_title_mb a .bar_tit span').text('去支付');
        }
        $("#dt_join_bar_title_mb a").css("background-color", "#f5a421");
        var src = $('#dt_join_bar_title_mb a img').attr('src').replace(/icon_man2.png/g, 'icon_pay.png');
        $('#dt_join_bar_title_mb a img').attr('src', src);
        _joinLoading._post();
      }
      $("#a_post").attr("href", "/post?hdb_from=WapPay" + _thisNext);
    }
  },
  _dataPost: function(_payItemId, _enrollOption, _nick, _mobile) {
    _$(_api3._isPayOrder, "party_id=" + _info._id, _payItemBox._checkOk);
  },
  _phone: function(_payItemId, _enrollOption, _nick, _mobile) {
    var _inputCode = _._trim($("#rg2_form_yzm").val());
    if (_inputCode == "") {
      $("#rg2_form_yzm").focus();
      _toast._show("请输入验证码");
      return false;
    }
    if (_getCode._code != _inputCode) {
      _toast._show("验证码不正确，请重试");
      return false;
    }
    _loading._show("加载中");
    var _flag = _$asyn(_detailApi3._verifyCode, "verify_code=" + _inputCode + "&mobile=" + _mobile, _joinForm._phoneOk);
    if (!_flag) {
      return false;
    }
    _phoneBox._hide();
    _joinForm._dataPost(_payItemId, _enrollOption, _nick, _mobile);
    return true;
  },
  _phoneOk: function(json, code) {
    _loading._hide();
    if (json.state.toString() != "0") {
      _toast._show(json.error, function() {
        _user._error(json.state, "verify_code");
      });
      return;
    }
  },
  _checkProperty: function() {
    var _re = false;
    var _toastArr = ["请报上你的大名", "请输入你的手机号", "请输入你所在的单位", "请输入你的职位", "请输入你所在的行业", "备注请在50个字以内"];
    var _lenArr = [20, 0, 40, 20, 20, 100, 400];
    var _lenToastArr = ["大名请少于10字", "手机号不正确", "单位名称请少于20字", "职位名称请少于10字", "行业信息请少于10字", "备注请少于50字", "请少于200字"];
    $("#ul_join_property li").each(function() {
      var inputType = $(this).attr("type");
      if ("danH" == inputType) {
        var _propertyId = $(this).find("input").attr("propertyid");
        var _value = _._trim($(this).find("input").val());
        if (_value == "") {
          if (_propertyId <= 5) {
            _toast._show(_toastArr[_propertyId - 1]);
            $(this).find("input").focus();
            _re = true;
            return false;
          } else if (_propertyId > 6) {
            var _name = $(this).find(".optionsName").text();
            _toast._show("请输入你的" + _name);
            $(this).find("input").focus();
            _re = true;
            return false;
          }
        } else {
          if (_value.match(/\^|\|/) != null) {
            _toast._show("不能包含特殊字符");
            $(this).focus();
            _re = true;
            return false;
          }
          if (_propertyId == 2) {
            //手机验证
            if (_joinForm._toVerifyMobile(_value)) {
              if (_value.match(/^1\d{10}$/) == null) {
                _toast._show("手机号不正确");
                $(this).focus();
                _re = true;
                return false;
              }
            } else {
              if (_value.match(/^\d{7,11}$/) == null) {
                _toast._show("手机号不正确");
                $(this).focus();
                _re = true;
                return false;
              }
            }
          } else {
            var _len = _._len(_value);
            if (_propertyId <= 6) {
              if (_len > _lenArr[_propertyId - 1]) {
                _toast._show(_lenToastArr[_propertyId - 1]);
                $(this).focus();
                _re = true;
                return false;
              }
            } else {
              if (_len > _lenArr[6]) {
                var _name = $(this).attr("placeholder");
                _toast._show(_name + _lenToastArr[6]);
                $(this).focus();
                _re = true;
                return false;
              }
            }
          }
        }
      } else if ("duoH" == inputType) {
        var _propertyId = $(this).find("textarea").attr("propertyid");
        var _value = _._trim($(this).find("textarea").val());
        if (_value == "") {
          var _name = $(this).find(".optionsName").text();
          _toast._show("请输入你的" + _name);
          $(this).find("textarea").focus();
          _re = true;
          return false;
        }
      } else if ("danX" == inputType) {
        var num = 0;
        $(this).find(".danXzu").find(".thisOver").each(function() {
          num++;
        });
        if (num == 0) {
          var _name = $(this).find(".optionsName").text();
          _toast._show("请选择：" + _name);
          _re = true;
          return false;
        }
      } else if ("duoX" == inputType) {
        var num = 0;
        $(this).find(".duoXzu").find(".thisOver").each(function() {
          num++;
        });
        if (num == 0) {
          var _name = $(this).find(".optionsName").text();
          _toast._show("请选择：" + _name);
          _re = true;
          return false;
        }
      }
    });
    return _re;
  },
  _getPorpertyValue: function() {
    var _proValue = "";
    $("#ul_join_property li").each(function() {
      if ($(this).attr("type") == 'danH') {
        _proValue += $(this).find("input").attr("propertyid") + "|" + $(this).find("input").val() + "^";
      } else if ($(this).attr("type") == 'duoH') {
        _proValue += $(this).find("textarea").attr("propertyid") + "|" + $(this).find("textarea").val() + "^";
      } else if ($(this).attr("type") == 'danX') {
        var idStr = $(this).attr("propertyid");
        var valueStr = "";
        $(this).find(".thisOver").each(function() {
          valueStr += $(this).attr("id") + ",";
        });
        _proValue += idStr + "|" + valueStr + "^";
      } else if ($(this).attr("type") == 'duoX') {
        var idStr = $(this).attr("propertyid");
        var valueStr = "";
        $(this).find(".thisOver").each(function() {
          valueStr += $(this).attr("id") + ",";
        });
        _proValue += idStr + "|" + valueStr + "^";
      }
    });
    return _proValue;
  },
  _init: function(id) {
    var n = $("#dt_list_main li").length;
    if (n == 0) {
      $("#dt_list_main").hide();
    } else {
      $("#dt_list_main").show();
    }
    _joinForm._id = id;
    _payItemBox._check_ispay2();
  },
  _next: function() {
    _joinBox._hide();
    if (_joinForm._price == 0){
      $("#a_submit_phone").show();
      $("#input_submit_phone").hide();
    }
    _phoneBox._show();
  },
  _getCacheValue: function() {
    $("#ul_join_property input").each(function() {
      var key = "party_pay_item_id_" + $(this).attr('propertyid');
      var value = _payItemBox._getTemp(key);
      if (value != undefined && value != "") {
        $(this).val(value);
      }
    });
    $("#ul_join_property textarea").each(function() {
      var key = "party_pay_item_id_" + $(this).attr('propertyid');
      var value = _payItemBox._getTemp(key);
      if (value != undefined && value != "") {
        $(this).val(value);
      }
    });
  },
  _payAfter: function() {
    _tc._hide("payLock");
    //_tc._show("tc_payQuestion");
  }
};

/*自定义项*/
var _joinBox = {
  _ie: true,
  _id: "",
  _currentTop: 0,
  _iosSet: function() {
    var y = $(window).height();
    _joinBox._currentTop = $(document).scrollTop();
    document.body.scrollTop = 0;
    $("body").css({"height": y + _joinBox._currentTop + "px","overflow": "hidden"});
    $("#cover2").height(y);
  },
  _initProperty: function() {
    $("#ul_join_property input").each(function() {
      var _value = _payItemBox._getTemp(_joinBox._id + "_pay_item_id_" + $(this).attr("propertyid"));
      if (_value != "") {
        $(this).val(_value);
      }
    });
  },
  _center: function() {
    var w = $("body").width();
    var _left;
    if (w > 1000) {
      _left = (w - 1000) / 2 + "px";
    } else {
      _left = 0 + "px";
    }
    $("#join_box").css({"left": _left,"bottom": "0px","z-index": "3000","position": "fixed"});
    $(".join_box_Xq_out").css({"max-height": $(window).height() - 48 + "px"});
  },
  _show: function(id) {
    if (_info._needNewPage != undefined && _info._needNewPage == "1") {
      //支付信息
      var _payItemId = "";
      if ($(".tc_c_feiLi li[class='able thisOver']").length > 0) {
        _payItemId = $(".tc_c_feiLi li[class='able thisOver']").attr("payitemid");
      }
      var url = "/joinParty?id=" + _info._id;
      if (_payItemId != undefined && _payItemId != "") {
        url += "&pay_item_id=" + _payItemId;
      }

      //跳新页报名时 页面保存活动来源参数 用于统计
      var searchWord = document.location.search || "";
      url += searchWord.indexOf("?") == -1 ? "" : ("&" + searchWord.substr(1, searchWord.length));

      var _thisNext = _info._type.replace(_info._type, function($1) {
	      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
	    });
	    if (!_user._login()) {
	      _user._toLogin(_thisNext);
	      return;
	    }
      _g(url);
      return;
    }
    _joinBox._id = id;
    _cover._show("cover2");
    _joinBox._center();
    if ($(".tc_c_feiLi li").length == 0) {
      $(".fanHui").hide();
      $(".blueBtn").css({"width": "100%"});
    }
    if (_user._useIOs()) {
      _joinBox._iosSet();
    } else {
      $("body").css({"height": "auto","overflow": "auto","margin-top": "0px"});
    }
    var y = $(window).height();
    $("#join_box").css({"bottom": -y + "px","display": "block"});
    $("#join_box").animate({"bottom": 0 + "px"}, 500);
    $(window).bind("resize", _joinBox._center);
    $("#cover2").bind("click", _joinBox._hide);
  },
  _touch: function() {
    if (!_user._useIOs()) {
      return;
    }
    $("#cover2").unbind("click");
    setTimeout(function() {
      $("#cover2").bind("click", _joinBox._hide);
    }, 1000);
  },
  _hide: function() {
    var y = $(window).height();
    $("#join_box").css({"position": "fixed"});
    $(".container,#cover2").show();
    $("#join_box").slideUp(300);
    _cover._hide("cover2");
    setTimeout(function() {
      $("#join_box").css({"position": "absolute","display": "none"});
    }, 500);
    if (_user._useIOs()) {
      $("body").css({"height": "auto","overflow": "auto","margin-top": "0px"});
      $(document).scrollTop(_joinBox._currentTop);
    }
  },
  _prev: function() {
    _joinBox._hide();
    _payItemBox._show(_joinBox._id);
  },
  _clear: function() {
    _payItemBox._setTemp(_joinBox._id + "_pay_item_id", "");
    _payItemBox._setTemp(_joinBox._id + "_agree", "");
    $("#ul_join_property input").each(function() {
      _payItemBox._setTemp(_joinBox._id + "_pay_item_id_" + $(this).attr("propertyid"), "");
    });
  }
};
/**支付项*/
var _payItemBox = {
  _id: "",
  _payOrderId: "",
  _init: function() {
    if (_payItemBox._getTemp(_payItemBox._id + "_pay_item_id") != "") {
      $("#li_pay_item_" + _payItemBox._getTemp(_payItemBox._id + "_pay_item_id")).addClass("thisOver");
    } else {
      if ($(".tc_c_feiLi li").length == 1) {
        var _li0 = $(".tc_c_feiLi li").eq(0);
        _li0.addClass("thisOver").siblings().removeClass("thisOver");
        _payItemBox._setTemp(_payItemBox._id + "_pay_item_id", _li0.attr("payitemid"));
      }
    }
    if (_payItemBox._getTemp(_payItemBox._id + "_agree") == "1") {
      $(".tc_c2 .xieyi span").attr("class", "thisOver");
      _payItemBox._setAgree($(".tc_c2 .xieyi span"));
    }
  },
  _setAgree: function(obj) {
    if (obj.attr("class") == "thisOver") {
      obj.parent().next("div").children("a").eq(0).show().siblings().hide();
      _payItemBox._setTemp(_payItemBox._id + "_agree", "1");
    } else {
      obj.parent().next("div").children("a").eq(1).show().siblings().hide();
      _payItemBox._setTemp(_payItemBox._id + "_agree", "0");
    }
  },
  _setTemp: function(key, value) {
    _t._set(key + "_" + _info._id + "_" + _info._type, value);
  },
  _getTemp: function(key) {
    return _t._get(key + "_" + _info._id + "_" + _info._type);
  },
  _center: function() {
    var w = $("body").width();
    var _left;
    if (w > 1000) {
      _left = (w - 1000) / 2 + "px";
    } else {
      _left = 0 + "px";
    }
    $("#join_box_fee").css({"left": _left,"bottom": "0px","z-index": "3000","position": "fixed"});
  },
  _show: function(id) {
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    $(".feiyong_l").width($('.content-body').width() - 130);
    _payItemBox._id = id;
    if (_info._isPay == "0" && $(".tc_c_feiLi li").length == 0) {
      $("#xdBtn_nopay").css("display", "block");
      $("#xdBtn").css("display", "none");
      _payItemBox._next();
      return;
    }
    /*支付项*/
    $(".tc_c_feiLi .able").click(function() {
      $(this).addClass("thisOver").siblings().removeClass("thisOver");
      _payItemBox._setTemp(_payItemBox._id + "_pay_item_id", $(this).attr("payitemid"));
    });
    /*否同意支付协议*/
    $(".tc_c2 .xieyi span").click(function() {
      $(this).attr("class", $(this).attr("class") == "thisOver" ? "" : "thisOver");
      _payItemBox._setAgree($(this));
    });
    _payItemBox._init();
    _cover._show("cover2");
    _payItemBox._center();
    $("#join_box_fee").slideDown(300);
    $("#cover2").bind("click", _payItemBox._hide);
    $(window).bind("resize", _payItemBox._center);
    $(".able").each(function() {
      if ($(this).children(".feiyong_r").html() == "0元") {
        $(this).children(".feiyong_r").html("免费").css({"color": "#333333"});
      }
    });
    $("#xdBtn_nopay").css("display", "block");
    $("#xdBtn").css("display", "none");
  },
  _hide: function() {
    $("#join_box_fee").slideUp(300);
    _cover._hide("cover2");
    $(".tc_c2 .xieyi span").unbind("click");
    $(".tc_c_feiLi .able").unbind("click");
  },
  _next: function() {
    var _payLen = $(".tc_c_feiLi li[class='able thisOver']").length;
    if ($(".tc_c_feiLi li").length > 0 && _payLen == 0) {
      _toast._show("请选择报名类型");
      return;
    }
    var _price = 0;
    if (_payLen > 0) {
      _price = /\d*(\.)?\d*/.exec($(".tc_c_feiLi li[class='able thisOver'] .feiyong_r").html())[0];
    }
    _payItemBox._hide();
    _joinBox._show(_payItemBox._id);
    _joinBox._initProperty();
  },
  _check_ispay: function() {
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    if (!_user._login()) {
      if (!_user._inHudongba()) {
        _joinBeforeLogin._mark("1");
      }
      _user._toLogin(_thisNext);
      return false;
    }
    _$(_api3._isPayOrder, "party_id=" + _info._id, _payItemBox._checkOk);
  },
  _check_ispay2: function() {
    if (!_user._login()) {
      return false;
    }
    _$(_api3._isPayOrder, "party_id=" + _info._id, _payItemBox._checkOk2);
  },
  _checkOk: function(json, code) {
    if (code != 200) {
      return;
    }
    _payItemBox._payOrderId = json.payOrder_id;
    if (json.prderstate == "2") { //已锁定
      var _oid = json.payOrder_id;
      $("#dt_join_bar_title_mb a").attr("onclick", "");
      if (_user._inHudongba()) {
        $("#submit_ljA,#dt_join_bar_title_mb a").bind("click", function() {
          HudongbaJsBridge["getPayPage"](_oid);
        });
        $('#dt_join_bar_title_mb a .bar_tit span').text('去支付');
      } else {
        $("#submit_ljA,#submit_cxA,#dt_join_bar_title_mb a").attr("href", _link._alipay + "?order_id=" + _payItemBox._payOrderId);
        $('#dt_join_bar_title_mb a .bar_tit span').text('去支付');
      }
      $("#dt_join_bar_title_mb a").css("background-color", "#f5a421");
      var src = $('#dt_join_bar_title_mb a img').attr('src').replace(/icon_man2.png/g, 'icon_pay.png');
      $('#dt_join_bar_title_mb a img').attr('src', src);
      _joinLoading._post();
    } else { //未锁定
      var _thisNext = _info._type.replace(_info._type, function($1) {
        return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
      });
      var _hideMobile = $("#hide_verify_mobile").val();
      var _payItemId = "";
      if ($(".tc_c_feiLi li[class='able thisOver']").length > 0) {
        _payItemId = $(".tc_c_feiLi li[class='able thisOver']").attr("payitemid");
      }
      if (_payItemId == "" && _info._payItemId != undefined && _info._payItemId != "") {
        _payItemId = _info._payItemId;
      }
      if (_joinForm._checkProperty()) {
        return false;
      }
      var _mobile = "";
      if ($("#input_pro_id_2").attr("id") != undefined) {
        _mobile = _._trim($("#input_pro_id_2").val());
        _joinForm._mobile = _mobile;
      }
      var _enrollOption = _joinForm._getPorpertyValue();
      var _nick = _._trim($("#input_pro_id_1").val());
      if (_joinForm._id == "party") {
        _$(_api3._joinParty, "h_share_uid=" + _info._shareUid + "&party_id=" + _info._id + "&pay_item_id=" + _payItemId + "&enroll_option=" + _._encode(_enrollOption) + "&big_name=" + _._encode(_nick) + "&mobile=" + _._encode(_mobile), _joinForm._ok);
      } else {
        _$(_api3._joinRecruit, "h_share_uid=" + _info._shareUid + "&recruit_id=" + _info._id + "&pay_item_id=" + _payItemId + "&enroll_option=" + _._encode(_enrollOption) + "&big_name=" + _._encode(_nick) + "&mobile=" + _._encode(_mobile), _joinForm._ok);
      }
    }
  },
  _checkOk2: function(json, code) {
    if (code != 200) {
      return;
    }
    _payItemBox._payOrderId = json.payOrder_id;
    if (json.prderstate == "2") { //未锁定
      var _oid = json.payOrder_id;
      $("#dt_join_bar_title_mb a").attr("onclick", "");
      if (_user._inHudongba()) {
        $("#dt_join_bar_title_mb a").bind("click", function() {
          HudongbaJsBridge["getPayPage"](_oid);
        });
        $('#dt_join_bar_title_mb a .bar_tit span').text('去支付');
      } else {
        $("#dt_join_bar_title_mb a").attr("href", _link._alipay + "?order_id=" + _payItemBox._payOrderId);
        $('#dt_join_bar_title_mb a .bar_tit span').text('去支付');
      }
      $("#dt_join_bar_title_mb a").css("background-color", "#f5a421");
      var src = $('#dt_join_bar_title_mb a img').attr('src').replace(/icon_man2.png/g, 'icon_pay.png');
      $('#dt_join_bar_title_mb a img').attr('src', src);
      if (document.referrer.indexOf('login') != -1) {
    	_payList._less();
        _payItemBox._payOrderId = json.payOrder_id;
        _joinBox._hide();
        _joinBeforeLogin._mark("");
        _backToRefresh._mark();
        _joinBox._clear();
        _tc._show("payLock");
        $("#dt_join_bar_title_mb a").attr("onclick", "");
        if (_user._inHudongba()) {
          $("#submit_ljA,#dt_join_bar_title_mb a").bind("click", function() {
            HudongbaJsBridge["getPayPage"](_oid);
          });
          $('#dt_join_bar_title_mb a .bar_tit span').text('去支付');
        } else {
          $("#submit_ljA,#submit_cxA,#dt_join_bar_title_mb a").attr("href", _link._alipay + "?order_id=" + _payItemBox._payOrderId);
          $('#dt_join_bar_title_mb a .bar_tit span').text('去支付');
        }
        $("#dt_join_bar_title_mb a").css("background-color", "#f5a421");
        var src = $('#dt_join_bar_title_mb a img').attr('src').replace(/icon_man2.png/g, 'icon_pay.png');
        $('#dt_join_bar_title_mb a img').attr('src', src);
        _joinLoading._post();
      }
    } else {
      setTimeout(function() {
        _joinBeforeLogin._continue();
      }, 500);
    }
  }
};

/**手机验证*/
var _phoneBox = {
  _currentTop: 0,
  _iosSet: function() {
    var y = $(window).height();
    _phoneBox._currentTop = $(document).scrollTop();
    document.body.scrollTop = 0;
    $("body").css({"height": y + _phoneBox._currentTop + "px","overflow": "hidden"});
    $("#cover2").height(y);
  },
  _show: function() {
    $(".join_box_ph p span").text($("#input_pro_id_2").val());
    _cover._show("cover2");
    _phoneBox._center();
    if (_user._useIOs()) {
      _phoneBox._iosSet();
    }
    $("#join_box_ph").slideDown(300);
    $(window).bind("resize", _phoneBox._center);
    $("#cover2").bind("click", _phoneBox._hide);
    _getCode._post();
  },
  _center: function() {
    var w = $("body").width();
    var _left;
    if (w > 1000) {
      _left = (w - 1000) / 2 + "px";
    } else {
      _left = 0 + "px";
    }
    $("#join_box_ph").css({"left": _left,"bottom": "0px","z-index": "3000","position": "fixed"});
  },
  _touch: function() {
    if (!_user._useIOs()) {
      return;
    }
    $("#cover2").unbind("click");
    setTimeout(function() {
      $("#cover2").bind("click", _phoneBox._hide);
    }, 1000);
  },
  _hide: function() {
    _getCode._count = 60;
    $("#hide_verify_mobile").val("0");
    $("#join_box_ph").slideUp(300);
    _cover._hide("cover2");
    if (_user._useIOs()) {
      $("body").css({"height": "auto","overflow": "auto","margin-top": "0px"});
      $(document).scrollTop(_phoneBox._currentTop);
    }
  }
};
var _getCode = {
  _count: 60,
  _code: "",
  _getTimer: null,
  _countDown: function() {
    $(".huoYzm_btn").attr("onclick", "");
    $(".huoYzm_btn").css({"background-color": "#dbdbdb","color": "#999999"});
    _getCode._getTimer = setInterval(function() {
      if (_getCode._count == 1) {
        _getCode._clear();
        return;
      }
      _getCode._count--;
      $(".huoYzm_btn").text(_getCode._count + "s");
    }, 1000);
  },
  _clear: function() {
    $(".huoYzm_btn").unbind("click");
    $(".huoYzm_btn").attr("onclick", "").click(eval(function() {
      _getCode._post();
    }));
    $(".huoYzm_btn").css({"background-color": "#0099e9","color": "#FFFFFF"});
    $(".huoYzm_btn").text("重发");
    clearInterval(_getCode._getTimer);
    _getCode._count = 60;
  },
  _post: function() {
    var _phone = $("#join_box_ph p span").text();
    if (!_phone.match(/^1\d{10}$/)) {
      return;
    }
    _loading._show("请稍候");
    _$(_detailApi3._sendCode, "mobile=" + _phone, _getCode._ok);
  },
  _ok: function(json, code) {
    _loading._hide();
    if (code != 200) {
      return;
    }
    _getCode._code = json.validation_code;
    $(".huoYzm_btn").unbind("click");
    _getCode._countDown();
    _toast._show("校验码已发送");
  }
};

/**分享图标的显示*/
var _share = {
  _init: function() {
    if (_user._inWeibo()) {
      $("#share_weixin_guide").attr("src", _imgCdn + "/images/guide_weibo.png?new");
      $("#div_weibo").show();
    } else if (_user._inWeixin()) {
      $("#share_weixin_guide").attr("src", _imgCdn + "/images/guide_weixin.png?new");
    } else if (_user._inQq()) {
      $("#share_qq_guide").attr("src", _imgCdn + "/images/guide_qq.png?new");
      $("#div_qq").show();
    } else if (_user._inHudongba() || _user._inMobile()) {
      $("#div_no_pc").show();
    } else {
      $("#div_pc").show();
    }
    if (!_user._inWeixin()) {
      $("#info_share").css({"color": "#999"});
    } else {
      $("#info_share").css({"color": "#999"});
      $("#info_share").attr("onclick", "");
    }
  },
  _toFriend: function() {
    if (_user._inHudongba()) {
      _cover._hide("cover2");
      HudongbaJsBridge["showSharePanel"]();
      return;
    }
    _toast._show("请点击菜单上的分享图标进行发送");
  },
  _joinSucess: function() {
    if (!_user._inMobile()) {
      _qr._show("share_qr");
    } else if (_user._inWeixin() || _user._inWeibo()) {
      _shareInWeixin._show();
    } else if (_user._inQq()) {
      _shareInQq._show();
    } else {
      _share._toFriend();
    }
    if (_postSucess._fromApp()) {
      setTimeout(function() {
        $(".inviteZu").css({"background-color": "#e5e5e5","-webkit-transition": "background-color 0.3s linear","-moz-transition": "background-color 0.3s linear"});
        setTimeout(function() {
          $(".inviteZu").css({"background-color": "#FFFFFF","-webkit-transition": "background-color 0.3s linear","-moz-transition": "background-color 0.3s linear"});
        }, 800);
      }, 200);
    }
  }
};
/*发布成功**/
var _postSucess = {
  _fromApp: function() {
    return _user._inHudongba() && location.href.toString().indexOf("current=postsucess") != -1;
  },
  _fromAppPreview: function() {
    return _user._inHudongba() && location.href.toString().indexOf("preview=1") != -1;
  },
  _fromWeb: function() {
    return document.referrer.indexOf("/post/" + _info._type) != -1;
  },
  _modify: function() {
    if (_user._inHudongba()) {
      HudongbaJsBridge["getModifyPage"](_info._id, _info._type, _info._title);
    } else {
      if (!window.localStorage) {
        _alert._show("浏览器版本过低", "请登录互动吧App后再进行操作", "一键安装App", function() {
          _download(_link._appDownload);
        }, "关闭提示");
        return;
      }
      var _refer = document.referrer;
      _refer = _refer.indexOf("?") != -1 ? _refer.split("?")[0] : _refer;
      _g(_refer + "?id=" + _info._id);
    }
  },
  _init: function() {
    if (_postSucess._fromApp()) {
      $("#dt_join_bar").hide();
      $(".dt_share").hide();
      $(".dt_post_sucess").show();
      $("#div_share_type").show();
      $("#dt_guess").hide();
      $("#dt_carte").hide();
      $(".userPicA,.subinfo_name").attr("href", "javascript:void(0)");
      return;
    }
    if (_postSucess._fromAppPreview()) {
      $(".dt_bestEvents,#div_share_type,.dt_post_sucess,#dt_join_menu_bg").hide();
      $("#dt_join_bar").show();
      $("#dt_join_bar").css("bottom", 0);
      $("#dt_carte").css("margin-bottom", 90 + "px");
      $("a,#dt_review_top,.dt_join_top,.dt_review_top").removeAttr("onclick");
      $("a").removeAttr("href");
      $("a,#dt_like,.dt_review_top,.dt_carte_new,.dt_join_bar_outside").addClass("tc_preview");
      $(".dt_review_item_count").html('<span>阅读 0　分享 0</span>');
      setTimeout(function() {
        $("#dt_join_bar_menu").removeAttr("href").addClass("tc_preview");
        $("#dt_guess_list_main li a").removeAttr("href").addClass("tc_preview");
        $(".tc_preview").click(function() {
          _toast._show("这是预览页面，先编辑完成后再点击查看", 100);
        });
      }, 1000);
      return;
    }
    if (_postSucess._fromWeb()) {
      $(".dt_post_sucess").show();
      $("#dt_join_bar").remove();
      $(".dt_join_bar_yao").show();
    }
    $("#dt_join_bar").css({"bottom": -57 + "px"});
    $(".dt_join_barR").css({"width": $(".dt_join_barC_nr").width() - 35 - $(".dt_join_barL").width() + "px","margin-right": 15 + "px","margin-left": 0});
    if (_info._coverImageUrl != undefined && _info._coverImageUrl != "" && _user._inHudongba && _user._useAndroid && _isCover != 1) {
      setTimeout(function() {
        $("#dt_join_bar").animate({"bottom": 0 + "px"}, "slow")//.show();
      }, 2000);
    } else {
      setTimeout(function() {
        $("#dt_join_bar").animate({"bottom": 0 + "px"}, "slow")//.show();
      }, 500);
    }
  },
  _showWin: function(type) {
    if (type == "qr") {
      _qr._show("share_qr_1");
      return;
    }
    HudongbaJsBridge["shareType"](type);
  }
};

/**评论、参与、猜你喜欢loading*/
var _bottomLoading = {
  _end: function(id, text) {
    $("#" + id).html("<span class=\"upAll\">" + text + "</span>");
    $("#" + id).unbind("click");
    $("#" + id).show();
  },
  _loading: function(id, text) {
    $("#" + id).html("<span class=\"upding\"><img src=\"" + _imgCdn + "/images3/loading2.gif\">" + text + "</span>");
    $("#" + id).unbind("click");
    $("#" + id).show();
    if (_user._useAndroid()) {
      $(".upding img").css({"margin-top": 0 + "px"});
    }
  },
  _more: function(id, text, fun) {
    $("#" + id).html("<a class=\"moreBtn\" ontouchstart=''><span>" + text + "</span></a>");
    $("#" + id).bind("click", fun);
    $("#" + id).show();
  },
  _hide: function(id) {
    $("#" + id).hide();
  }
};

/**评论前判断*/
var _reviewBeforeLogin = {
  _mark: function(value) {
    _t._set("review_before_login_" + _info._type + "_" + _info._id, value);
  },
  _continue: function() {
    if (_t._get("review_before_login_" + _info._type + "_" + _info._id) != "") {
      setTimeout(function() {
        _reviewBeforeLogin._post();
        _review._post();
      }, 500);
    }
  },
  _setTemp: function(key, value) {
    _t._set(key + "_" + _info._type + "_" + _info._id, value);
  },
  _getTemp: function(key) {
    return _t._get(key + "_" + _info._type + "_" + _info._id);
  },
  _post: function() {
    _review._replyUid = _reviewBeforeLogin._getTemp("review_replyUid");
    _review._questionId = _reviewBeforeLogin._getTemp("review_questionId");
    $("#dt_review_form_content").attr("placeholder", "继续评论/回复：");
    _reviewBox._show();
  }
};
var _backToRefresh = {
  _mark: function() {
    _t._set("join_sucess", "/" + _info._type + "/" + _info._id);
  },
  _should: function() {
    return _t._get("join_sucess") != "" && document.referrer != "" && document.location.href.indexOf(_t._get("join_sucess")) != -1;
  },
  _clear: function() {
    _t._set("join_sucess", "");
  }
};

//已展示评论的id，防止由于后台缓存原因，重复展示
var alreadyShowDiscussId = new Array();
function contains(ary, newId) {
  if (ary instanceof Array) {
    for (var i = 0; i < ary.length; i++) {
      var id = ary[i];
      if (id == newId) {
        return true;
      }
    }
  }
  return false;
}

/**评论*/
var _review = {
  _replyUid: "0",
  _pId: "0",
  _post: function() {
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _content = _emo._toCode(_._trim($("#dt_review_form_content").val()));
    if (_content == "") {
      return;
    }
    if (_._len(_content) > 200) {
      _toast._show("评论请在100字以内");
      return;
    }
    if (!_user._login()) {
      _reviewBeforeLogin._mark("1");
      _user._toLogin(_thisNext);
      return;
    }
    _loading._show("请稍候");
    if (_review._replyUid == "0") {
      _$(_api3._review, "h_share_uid=" + _info._shareUid + "&info_id=" + _info._id + "&info_type=" + _info._type + "&replyUserid=" + _review._replyUid + "&content=" + _._encode(_content), _review._ok);
    } else {
      _$(_api3._review, "h_share_uid=" + _info._shareUid + "&info_id=" + _info._id + "&info_type=" + _info._type + "&replyUserid=" + _review._replyUid + "&pId=" + _review._pId + "&content=" + _._encode(_content), _review._ok);
    }
  },
  _ok: function(json, code) {
    _loading._hide();
    if (json.state.toString() != "0") {
      _toast._show(json.error, function() {
        _user._error(json.state, "review");
      });
      return;
    }
    var _data = json.discuss_info;
    var _pId = _data.pId;
    var _item = _review._itemDom(_data.id, _pId, _data.userId, _data.userName, _data.replyUserId, _data.replyUserName, _data.date, _data.discussContent, _data.user_pic, _data.nick_name);
    $("#dt_review_main").html(_item + $("#dt_review_main").html());
    $("#dt_review_main").show();
    var _total = 1;
    if ($("#review_total").attr("id") != undefined) {
      _total = parseInt($("#review_total").html()) + 1;
    }
    $("#dt_review_count").html("<span id=\"review_total\">" + _total + "</span>条评论");
    $("#mb_bar_review_count").html("<span>评论(" + _total + ")</span>");
    if (_info._type == "job") {
      $("#dt_review_count").html("<span id=\"review_total\">" + _total + "</span>人留言");
    }
    _review._reset();
    if (_postSucess._fromApp()) {
      $("#dt_review_item_" + _data.id + " a").attr("href", "javascript:void(0)");
    }
    _scroollTop._top(".dt_review", 500, 200);
    $("#dt_review_form_content").val("");
    _reviewBox._setTemp("review_content", "");
    _reviewBeforeLogin._setTemp("review_replyUid", "");
    _reviewBeforeLogin._mark("");
    _backToRefresh._mark();
    _reviewBox._hide();
  },
  _okFromApp: function(json) {
    _review._ok(json, 200);
  },
  _itemDom: function(id, pId, userId, userName, replyUserId, replyUserName, date, discussContent, userImg, nick_name) {
    //**敏感字校验**
    if (!verifyWord(userName)) {
      userName = '互动吧用户';
    }
    if (!verifyWord(replyUserName)) {
      replyUserName = '互动吧用户';
    }
    if (!verifyWord(nick_name)) {
      nick_name = "互动吧用户";
    }
    //**敏感字校验**
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _item = "<li ontouchstart='' id=\"dt_review_item_" + id + "\" class=\"dt_review_main\" onclick=\"_reviewBox._rePost('" + userId + "','" + userName + "','" + nick_name + "','" + pId + "')\">" 
    	+ "<div class=\"dt_review_main_K\"><div class=\"dt_review_icon\"><a onclick=\"\" href=\"/timeline/" + userId + "-WapArticleHeader.html?hdb_from=" + _khDuan._duanId + _thisNext + "Comment\">";
    if (userImg == "") {
      _item += "<img class=\"default_img\" src=\"" + _imgCdn + "/static_v4/images/other/face_default_200.png\">";
    } else {
      _item += "<img class=\"default_img\"  src=\"" + userImg + "\" onerror=\"this.src='" + _imgCdn + "/static_v4/images/other/face_default_200.png'\">";
    }
    _item += "</a></div><div class=\"dt_review_title dt_loadNew\"><a ontouchstart='' href=\"/timeline/" + userId + "-WapArticleHeader.html?hdb_from=" + _khDuan._duanId + _thisNext + "Comment\">" + userName + "</a>";
    _item += "</div>" + "<p class=\"dt_review_time\">" + date + "</p>" + "<div class=\"dt_review_body\">";
    if (replyUserId != "0") {
      _item += "回复<a ontouchstart=\"\"  href=\"/timeline/" + replyUserId + "-WapArticleHeader.html?hdb_from=" + _khDuan._duanId + _thisNext + "Comment\">" + replyUserName + "</a>：";
    }
    _item += "" + discussContent + "</div></div></li>";
    return _item;
  },
  _reset: function() {
    _guess._reset();
    _reviewLoading._delParent();
  }
};
/**评论框*/
var _reviewBox = {
  _currentTop: 0,
  _iosSet: function() {
    var y = $(window).height();
    _reviewBox._currentTop = $(document).scrollTop();
    document.body.scrollTop = 0;
    $("body").css({"height": y + _reviewBox._currentTop + "px","overflow": "hidden","margin-top": -_reviewBox._currentTop + "px"});
    $("#cover2").height(y);
  },
  _show: function(uName, nick) {
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    if (_user._inHudongba()) {
      if (_review._replyUid == "0") {
        HudongbaJsBridge["showReviewPanel"](_info._id, _info._type, _review._replyUid, nick || "", "");
      } else {
        HudongbaJsBridge["showReviewPanel"](_info._id, _info._type, _review._replyUid, nick || "", _review._pId);
      }
      return;
    }
    if (!_user._login() && !window.localStorage) {
      _user._toLogin(_thisNext);
      return;
    }
    _cover._show("cover2");
    $("#dt_review_box").show();
    _reviewBox._inputed();
    if (!_user._useIOs()) {
      $("#dt_review_form_content").focus();
    } else {
      _reviewBox._iosSet();
    }
    $("#dt_review_form_content").val(_reviewBox._getTemp("review_content"));
    $("#cover2").bind("click", _reviewBox._hide);
  },
  _hide: function() {
    if (_user._useIOs()) {
      $("body").css({"height": "auto","overflow": "auto","margin-top": "0px"});
    }
    _cover._hide("cover2");
    $("#dt_review_box").hide();
    _emo._hide("dt_review_box_emo");
    $("body").css({"height": "auto","overflow": "auto"});
  },
  _post: function() {
    _scroollTop._top(".dt_review", 500, 200);
    _review._replyUid = 0;
    var _reviewFrom = $("#dt_review_form_content")[0];
    _reviewFrom.setAttribute("placeholder", "评论：");
    if (_info._type == "job") {
      _reviewFrom.setAttribute("placeholder", "留言：");
    }
    _reviewBox._show();
  },
  _rePost: function(uId, uName, nick, pId) {
    _review._replyUid = uId;
    _review._pId = pId;
    var _reviewFrom = $("#dt_review_form_content")[0];
    _reviewFrom.setAttribute("placeholder", "回复" + uName + "：");
    _reviewBox._show(uName, nick);
  },
  _touch: function() {
    if (!_user._useIOs()) {
      return;
    }
    $("#cover2").unbind("click");
    setTimeout(function() {
      $("#cover2").bind("click", _reviewBox._hide);
    }, 1000);
    _emo._hide("dt_review_box_emo");
    $("#dt_review_form_content").focus();
  },
  _focus: function() {
    if (_user._useIOs()) {
      return;
    }
    _emo._hide("dt_review_box_emo");
    with($("#dt_review_form_content")) {
      var _value = $("#dt_review_form_content").val();
      $("#dt_review_form_content").val("");
      $("#dt_review_form_content").val(_value);
    }
  },
  _blur: function() {
    _reviewBox._setTemp("review_content", $("#dt_review_form_content").val());
    _reviewBeforeLogin._setTemp("review_replyUid", _review._replyUid);
  },
  _inputed: function() {
    $("#dt_review_form_post").attr("class", _._trim($("#dt_review_form_content").val()) == "" ? "button_1_disabled" : "button_1");
  },
  _setTemp: function(key, value) {
    _t._set(key + "_" + _info._type + "_" + _info._id + "_" + _review._replyUid, value);
  },
  _getTemp: function(key) {
    return _t._get(key + "_" + _info._type + "_" + _info._id + "_" + _review._replyUid);
  },
  _showEmo: function() {
    _emo._show("dt_review_box_emo", function(index) {
      $("#dt_review_form_content").val($("#dt_review_form_content").val() + _emo._text[index]);
      _reviewBox._inputed();
      _reviewBox._blur();
    });
  }
};

/**评论列表*/
var _reviewLoading = {
  _total: 0,
  _nowTime: 0,
  _index: 1,
  _flag: false,
  _init: function() {
    var n = $("#dt_review_main li").length;
    if (n == 0) {
      $("#dt_review_main").hide();
    } else {
      $("#dt_review_main").show();
    }
    _reviewBeforeLogin._continue();
    _reviewLoading._post();
  },
  _post: function() {
    if (_reviewLoading._flag == true) {
      return;
    }
    _reviewLoading._flag = true;
    _bottomLoading._loading("review_loading", "正在加载...");
    _$(_api3._reviewList, "info_id=" + _info._id + "&info_type=" + _info._type + "&page_num=" + _reviewLoading._index + "&now_time=" + _reviewLoading._nowTime + "&count=" + _reviewLoading._total, _reviewLoading._ok);
  },
  _ok: function(json, code) {
    _bottomLoading._hide("review_loading");
    var _state = json.state;
    if (code != 200 || (code == 200 && _state != "0")) {
      _bottomLoading._more("review_loading", "网络错误，点击重新加载", _reviewLoading._post);
      return;
    }
    var _data = json.discussArray,
      _len = _data.length;
    _reviewLoading._nowTime = json.nowTime;
    if (_reviewLoading._index == 1) {
      _reviewLoading._total = json.total;
      if (json.total == "0") {
        $("#dt_review_count").html("快来发表你的评论");
        if (_info._type == "job") {
          $("#dt_review_count").html("快来发送留言");
        }
      } else {
        $("#dt_review_count").html("<span id=\"review_total\">" + json.total + "</span>条评论");
        $("#mb_bar_review_count").html("<span>评论(" + json.total + ")</span>");
        if (_info._type == "job") {
          $("#dt_review_count").html("<span id=\"review_total\">" + json.total + "</span>人留言");
        }
      }
    }
    if (_len == 0) {
      return;
    }
    if (json.nextState.toString() == "1") {
      _reviewLoading._flag = false;
      _reviewLoading._index++;
      if (_info._type == "job") {
        _bottomLoading._more("review_loading", "展开更多留言", _reviewLoading._post);
      } else {
        _bottomLoading._more("review_loading", "展开更多评论", _reviewLoading._post);
      }
    }
    var _html = "";
    for (var i = 0; i < _len; i++) {
      var id = _data[i].discussId;
      var pId = _data[i].pId;
      if (!contains(alreadyShowDiscussId, id)) {
        alreadyShowDiscussId.push(id);
        var _item = _review._itemDom(id, pId, _data[i].userId, _data[i].nickName, _data[i].replyUserId, _data[i].replyNickName, _data[i].date, _data[i].discussContent, _data[i].userPic, _data[i].nick_name);
        _html += _item;
      }
    }
    $("#dt_review_main").html($("#dt_review_main").html() + _html);
    $("#dt_review_main").show();
    _review._reset();
  },
  _delParent: function() {
    $("#dt_review_main .dt_review_icon a,#dt_review_main .dt_review_title").bind("click", function(event) {
      event.stopPropagation();
    });
  }
};

/**参与列表*/
var _joinLoading = {
  _total: 0,
  _nowTime: 0,
  _index: 1,
  _flag: false,
  _init: function() {
    _joinLoading._post();
  },
  _post: function() {
    if (_joinLoading._flag == true) {
      return;
    }
    _joinLoading._flag = true;
    _bottomLoading._loading("join_loading", "正在加载...");
    _$(_api3._joinList, "info_id=" + _info._id + "&info_type=" + _info._type + "&page_num=" + _joinLoading._index + "&now_time=" + _joinLoading._nowTime + "&count=" + _joinLoading._total, _joinLoading._ok);
  },
  _ok: function(json, code) {
    _bottomLoading._hide("join_loading");
    var _state = json.state;
    if (code != 200 || (code == 200 && _state != "0")) {
      _bottomLoading._more("join_loading", "网络错误，点击重新加载", _joinLoading._post);
      return;
    }
    var _data = json.enrollArray,
      _len = _data.length;
    _joinLoading._nowTime = json.nowTime;
    if (_joinLoading._index == 1) {
      var total_html = "<span id=\"join_total\">" + json.total + "</span>人已完成报名";
      var pay_html = json.ispay_count + "人正在支付";
      var d_html = "快来报名参加";
      if (json.ispay_count > 0) {
        total_html += "，" + pay_html;
        d_html = pay_html;
      }
      _joinLoading._total = json.total;
      if (json.total == "0") {
        $("#dt_join_count").html(d_html);
        $("#dt_join_menu_bg .dt_join_top").bind("click", function() {
          _payItemBox._show(_info._type);
        });
      } else {
        $("#dt_join_count").html(total_html);
      }
    }
    if (_len == 0) {
      return;
    }
    if (json.nextState.toString() == "1") {
      _joinLoading._flag = false;
      _joinLoading._index++;
      _bottomLoading._more("join_loading", "展开更多报名", _joinLoading._post);
    }
    var _html = "";
    for (var i = 0; i < _len; i++) {
      var _item = _joinLoading._addItem(_data[i].userId, _data[i].bigName, _data[i].userPic, _data[i].date, _data[i].joinId);
      _html += _item;
    }
    $("#dt_list_main").html($("#dt_list_main").html() + _html);
    $("#dt_list_main").show();
    _guess._reset();
  },
  _addItem: function(userId, userNick, userImg, date, joinId) {
    //**敏感字校验**
    if (!verifyWord(userNick)) {
      userNick = '互动吧用户';
    }
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _item = "<li id=\"div_join_id_" + joinId + "\" class=\"dt_review_main\" ontouchstart=''><div class=\"dt_review_K\"><div class=\"dt_guess_item_icon\"><a ontouchstart='' href=\"/timeline/" + userId + "-WapArticleHeader.html?hdb_from=" + _khDuan._duanId + _thisNext + "List\">";
    if (userImg == "") {
      _item += "<img class=\"default_img\" src=\"" + _imgCdn + "/static_v4/images/other/face_default_200.png\"/>";
    } else {
      _item += "<img class=\"default_img\"  src=\"" + userImg + "\" onerror=\"this.src='" + _imgCdn + "/static_v4/images/other/face_default_200.png'\"/>";
    }
    _item += "</a></div><div class=\"dt_guess_item_title dt_loadNew\"><a ontouchstart='' href=\"/timeline/" + userId + "-WapArticleHeader.html?hdb_from=" + _khDuan._duanId + _thisNext + "List\">" + userNick + "</a></div><p class=\"dt_guess_item_time\">" + date + "</p></div></li>";
    return _item;
  }
};

/**赞相关*/
var _like = {
  _total: 0,
  _index: 1,
  _nowTime: 0,
  _post: function() {
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    if (!_user._login()) {
      if (!_user._inHudongba()) {
        _likeBeforeLogin._mark("1");
      }
      _user._toLogin(_thisNext);
      return;
    }
    _$(_api3._like, "h_share_uid=" + _info._shareUid + "&info_type=" + _info._type + "&info_id=" + _info._id, _like._ok);
  },
  _ok: function(json, code) {
    if (code != 200) {
      _like._likeFailed();
      return;
    }
    if (json.state.toString() != "0") {
      _toast._show(json.error, function() {
        _user._error(json.state, "like");
      });
      return;
    }
    _like._liked();
    _backToRefresh._mark();
    _likeBeforeLogin._mark("");
    var _item = _like._itemDom(json.user.user_id, json.user.user_name);
    $("#dt_like_list span").after(_item);
    if ($("#dt_like_count").attr("id") != undefined) {
      $("#dt_like_count").html(parseInt($("#dt_like_count").html()) + 1);
      var count = $("#mb_bar_like_count span").attr("count");
      $("#mb_bar_like_count").html("<span count='" + (parseInt(count) + 1) + "'>" + (parseInt(count) + 1) + "</span>");
    } else {
      var count = $("#mb_bar_like_count span").attr("count");
      if (count == NaN || count == undefined) {
        count = 0;
      }
      var newCount = parseInt(count) + 1;
      $("#dt_like p").html("赞(<span id=\"dt_like_count\">" + newCount + "</span>)");
      $("#mb_bar_like_count").html("<span count='" + newCount + "'>赞(" + newCount + ")</span>");
    }
    $("#dt_like_main").show();
    if (_postSucess._fromApp()) {
      $("#dt_like_list_" + json.user.user_id).attr("href", "javascript:void(0)");
    }
    $("#icon_zan_ok2").animate({
      width: "38px",
      height: "38px",
      left: "-11px",
      top: "-11px"
    }, 100, function() {
      $("#icon_zan_ok2").animate({
        width: "14px",
        height: "13px",
        left: "0px",
        top: "0px"
      }, 300);
    });
    if (_user._inHudongba()) {
      var _src = $("#icon_zan_ok").attr("src");
      $("#icon_zan_ok").attr("src", _src.replace("dt_like3_2.png", "dt_like3_2_on.png"));
      $("#icon_zan_ok").animate({
        width: "38px",
        height: "38px",
        left: "-10px",
        top: "-10px"
      }, 100, function() {
        $("#icon_zan_ok").animate({
          width: "18px",
          height: "18px",
          left: "0px",
          top: "0px"
        }, 300);
      });
    }
  },
  _getFlag: false,
  _get: function() {
    if (_like._getFlag) {
      return;
    }
    _like._getFlag = true;
    _$(_api3._likeList, "info_type=" + _info._type + "&info_id=" + _info._id + "&page_num=" + _like._index + "&now_time=" + _like._nowTime + "&count=" + _like._total, _like._getOk);
  },
  _getOk: function(json, code) {
    if (code != 200 || (code == 200 && json.state != "0")) {
      _like._getFlag = false;
      return;
    }
    var _data = json.likeArray,
      _len = _data.length;
    var _isLike = json.isLike;
    _like._nowTime = json.nowTime;
    if (_isLike != 1) {
      _likeBeforeLogin._continue();
    }
    if (_like._index == 1) {
      if (_isLike == 1) {
        _like._liked();
      }
      _like._total = json.total;
      if (json.total > 0) {
        $("#dt_like p").html("赞(<span id=\"dt_like_count\">" + json.total + "</span>)");
        $("#dt_like_main").show();
      }
      $("#mb_bar_like_count").html("<span count='" + json.total + "'>赞(" + json.total + ")<span>");
    }
    if ($("#dt_like_more").attr("href") != undefined) {
      $("#dt_like_more").remove();
    }
    for (var i = 0; i < _len; i++) {
      $("#dt_like_list").append(_like._itemDom(_data[i].userId, _data[i].nickName));
    }
    if (json.nextState == "1") {
      var _a = "<a id=\"dt_like_more\" class=\"dt_nick\" ontouchstart=\"\" onclick=\"_like._get()\" href=\"javascript:void(0)\">&nbsp;&nbsp;更多…</a>";
      $("#dt_like_list").append(_a);
      _like._getFlag = false;
      _like._index++;
    }
  },
  _liked: function() {
    if (_user._inHudongba()) {
      var _src = $("#icon_zan_ok").attr("src");
      $("#icon_zan_ok").attr("src", _src.replace("dt_like3_2.png", "dt_like3_2_on.png"));
    }
    if ($("#dt_like").children("a").attr("href") == undefined) {
      return;
    }
    var _src = $("#img_dt_like").attr("src");
    $("#img_dt_like").attr("src", _src.replace("dt_like2.png", "dt_like_yes.png"));
    $("#dt_like").html($("#dt_like").children().eq(0).html());
  },
  _likeFailed: function() {
    $("#dt_like").html("<a ontouchstart='' href='javascript:_like._post()'>" + $("#dt_like").html() + "</a>");
  },
  _itemDom: function(userId, userName) {
    //**敏感字校验**
    if (!verifyWord(userName)) {
      userName = '互动吧用户';
    }
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _a = "<a ontouchstart='' href=\"/timeline/" + userId + "-WapArticleHeader.html?hdb_from=" + _khDuan._duanId + _thisNext + "Like\" class=\"dt_nick\" id=\"dt_like_list_" + userId + "\">" + userName + "</a>";
    return _a;
  },
  _init: function() {
    setTimeout(_like._get, 500);
  }
};
var _likeBeforeLogin = {
  _mark: function(value) {
    _t._set("like_before_login_" + _info._type + "_" + _info._id, value);
  },
  _continue: function() {
    if (_t._get("like_before_login_" + _info._type + "_" + _info._id) != "") {
      setTimeout(function() {
        _scroll._to($("#dt_like").scrollTop() - 100);
      }, 500);
    }
  }
};
/**阅读、分享*/
var _infoHintsShare = {
  _post: function() {
    _$(_api3._infoHintShare, "info_id=" + _info._id + "&info_type=" + _info._type, _infoHintsShare._ok);
  },
  _ok: function(json, code) {
    if (json != null) {
      $("#info_hits").html("阅读 " + json.hits);
      if (json.share > 0) {
        $("#info_share").html("分享 " + json.share + "+");
      } else {
        $("#info_share").html("分享 " + json.share);
      }
    }
    $(".subinfo_name").css("max-width", ($("body").width() - 85 - $(".fbTime").width() - $(".dt_review_item_count").width()) + "px");
  }
};

/**外链*/
var _support = {
  _url: "",
  _format: function(id) {
    var _html = $("#" + id).html();
    var _reg = /([^"])((https?:\/\/)([a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?)(\/[a-zA-Z0-9\?%=&#;_\.\-\+\/]+)?)/gi;
    _html = _html.replace(_reg, function(data) {
      var _dataTemp = data.substring(1, data.length);
      var _pre = data.substring(0, 1);
      if (data.indexOf(_domain) > -1 || data.indexOf("hudong.ba") > -1 || data.indexOf("hudongba.mobi") > -1 || data.indexOf("hdb.com") > -1 || _isNoAlertUser == "1") {
        return _pre + "<a class='dt_hdb_support' href='" + _dataTemp + "'>" + _dataTemp + "</a>";
      } else {
        return _pre + "<a class='dt_support' href='javascript:void(0);' onclick='_support._hint(\"" + _dataTemp + "\")'>" + _dataTemp + "</a>";
      }
    });
    if (_user._inMobile()) {
      var r = /((<a\s[^>]*>[^<]*?)?((\+?86)?(\d{3,5}\-)?\d{7,19})([^<]*<\/a>)?)|(<img\s[^>]*\/?>)|(<iframe\s[^>]*><\/iframe>)/g;
      _html = _html.replace(r, function(data) {
        if (/^(\+?86)?(\d{3,5}\-)?\d{7,19}$/.test(data))
          return "<a class='dt_support' href='tel:" + data + "'>" + data + "</a>";
        else
          return data;
      });
    }
    _html = _html.replace(/\'([^\']*)\'/ig, function(a) {
      return a.replace(/((from)|(isappinstalled))=/ig, "");
    });
    $("#" + id).html(_html);
    _html = null;
  },
  _hint: function(temp) {
    _support._url = temp;
    _support._box();
  },
  _init: function() {
    if ($("#dt_content").attr("id") != undefined) {
      _support._format("dt_content");
    }
    if ($("#dt_contact_content").attr("id") != undefined) {
      _support._format("dt_contact_content");
    }
    if ($("#dt_vote_result").attr("id") != undefined) {
      _support._format("dt_vote_result");
    }
    if (_user._inHudongba()) {
      /*app处理*/
      var aa = $("a[href^='" + _domain + "post']").attr("class");
      var aa1 = $("a[href='http://hudong.ba']").attr("class");
      if (undefined != aa1) {
        $("a[href='http://hudong.ba']").bind("click", function() {
          HudongbaJsBridge["showPostPanel"]();
        });
        $("a[href='http://hudong.ba']").attr("href", "javascript:void(0);");
      }
      var pp = $("a[href^='" + _domain + "post/']").attr("class");
      if (undefined != pp) {
        $("a[href^='" + _domain + "post/']").bind("click", function() {
          var _aHref = _._trim($(this).html());
          var _timpType = _aHref.substring(_aHref.indexOf("/post/") + 6, _aHref.length);
          var _tempId = "0";
          if (_aHref.indexOf("?") > -1) {
            _timpType = _timpType.substring(0, _timpType.indexOf("?"));
            var _params = _aHref.substring(_aHref.indexOf("?") + 1, _aHref.length);
            var _paramsArr = _params.split("&");
            for (var i = 0; i < _paramsArr.length; i++) {
              var _para = _paramsArr[i].split("=");
              if (_para[0] == "temp") {
                _tempId = _para[1];
                break;
              }
            }
          }
          $(this).attr("href", "javascript:void(0);");
          if (_tempId != "0") {
            _$(_detailApi3._template, "temp_id=" + _tempId + "&temp_type=" + _timpType, _support._infoPanel);
          } else {
            HudongbaJsBridge["showPostInfoPanel"](_timpType, "", "", "");
          }
        });
      }
    }
  },
  _infoPanel: function(json, code) {
    if (code != 200) {
      return;
    }
    HudongbaJsBridge["showPostInfoPanel"](json.template.template_type, json.template.template_title, json.template.template_content, json.template.template_text);
  },
  _center: function() {
    var _top = _._zero(_._client().bh - $("#tc_support").outerHeight()) / 2 + "px";
    var _left = _._zero(_._client().bw - $("#tc_support").outerWidth()) / 2 + "px";
    $("#tc_support").css({"left": _left,"bottom": _top,"z-index": "3000","position": "fixed"});
  },
  _box: function() {
    _cover._show("cover2");
    _support._center();
    $("#tc_support").show();
    $("#cover2").bind("click", _support._hide);
  },
  _hide: function() {
    $("#tc_support").hide();
    _cover._hide("cover2");
  },
  _ok: function() {
    _support._hide();
    _g(_support._url);
  }
};
function detail2Js_pc() {
  var y = $(window).height();
  $(".content-body").css("min-height", y + "px");
};
function detail2Js_mb() {
  var y = $(window).height(),
    w = $("body").width();
  $(".inviteZu li span").width(w * 0.137);
  $(".inviteZu li span").height(w * 0.137);
  $(".subinfo_name").css("max-width", w - 85 - $(".fbTime").width() - $(".dt_review_item_count").width() + "px");
  $(".dt_join_barR").css({"width": $("body").width() - 35 - $(".dt_join_barL").width() + "px","margin-right": 15 + "px","margin-left": 0});
  $(".tc_c_feiLi").css("max-height", (y - 144) + "px");
};
window.onscroll = function() {
  var barTop = $(document).scrollTop();
  $(".content-sidebar").css("margin-top", barTop + 50 + "px");
};
/**强制刷新*/
var _reFresh = function() {
  if (_backToRefresh._should()) {
    _backToRefresh._clear();
    _g(document.location.href);
  };
};
//旋转y
function _orientationchange() {
  switch (window.orientation) {
    //竖屏模式
    case 0:
    case 180:
      _listener();
      if (_info._coverImageUrl != undefined && _info._coverImageUrl != "") {_fm._count();}
      break;
      //横屏模式
    case -90:
    case 90:
      _listener();
      if (_info._coverImageUrl != undefined && _info._coverImageUrl != "") {_fm._count();}
      break;
  }
}

//视频高度
function _listener() {
  var w = $("body").width();
  if (_user._inHudongba()) {
    w = $("#dt_join_bar").width();
  } else {
    var y = $(window).height();
    if (w > y) {
      w = y;
    }
  }
  $(".iframe_mov").width(w - 30);
  $(".iframe_mov").height((w - 30) * 372 / 450);
  setTimeout(function() {
    detail2Js_mb();
  }, 1000);
};
//名信片
var _useCare = {
  _flag: false,
  _initFirst: function() {
    if (($("#dt_review").offset().top + $("#dt_review").height() - $(window).height()) < $(document).scrollTop()) {
      _useCare._post();
    }
  },
  _init: function() {
    _useCare._post();
  },
  _post: function() {
    if (_useCare._flag) {
      return;
    }
    _useCare._flag = true;
    _$(_detailApi3._care, "userId=" + $("#input_user_id").val(), _useCare._ok);
  },
  _ok: function(json, code) {
    if (code != 200) {
      return;
    }
    var _html = "";
    if (json != null) {
      var _data = json.data;
      var _len = _data.length;
      if (_len < 4) {
        return;
      }
      var _pSize = 0;
      for (var i = 0; _pSize < 3 && i < _len; i++) {
        var _d = _data[i];
        if (!(_info._id == _d.infoId36 && _info._type == _d.infoType)) {
          _html += _useCare._item(_d);
          _pSize++;
        }
      }
    }
    $(".dt_carte_num span").html(json.count);
    $(".dt_carte_list ul").html(_html);
  },
  _item: function(d) {
    var _item = "";
    _item = '<li><a href="/' + d.infoType + '/' + d.infoId36 + '?hdb_from=DSelf" class="dt_carte_list_a" ontouchstart="">' + '<img src="' + _imgCdn + '/images3/icon/' + d.infoType + '2x.png" class="dt_carte_list_pic" />' + '<div class="dt_carte_list_title">' + d.infoTitle + '</div>' + '</a></li>';
    return _item;
  }
};

var _footBar = {
  _init: function() {
    if (!_user._inHudongba()) {
      if (_info._type == 'article') {
        $("#dt_join_bar_title a").html("发表评论");
        $("#dt_join_bar_title a").attr("onclick", "");
        $("#dt_join_bar_title a").attr("href", "javascript:void(0)");
        $("#dt_join_bar_title a").bind("click", function() {
          _reviewBox._post();
        });
      } else if (_info._type == 'job') {
        $("#dt_join_bar_title a").html("发送留言");
        $("#dt_join_bar_title a").attr("onclick", "");
        $("#dt_join_bar_title a").attr("href", "javascript:void(0)");
        $("#dt_join_bar_title a").bind("click", function() {
          _reviewBox._post();
        });
      }
    }
  }
};

var _khDuan = {
  _duanId: "",
  _init: function() {
    if (!_user._inMobile()) {
      _khDuan._duanId = "PC";
    } else if (_pub_client == "hdb_android") {
      _khDuan._duanId = "A";
    } else if (_pub_client == "hdb_ios") {
      _khDuan._duanId = "I";
    } else {
      _khDuan._duanId = "Wap";
    }
  }
};

function goMore() {
  if (_user._inHudongba() && _user._useIOs()) {
    //跳转ios
    HudongbaJsBridge["showPostWonderfulPanel"]("", "", "", "");
  } else if (_user._inHudongba() && _user._useAndroid()) {
    //跳转android
    HudongbaJsBridge["showFindPanel"]();
  } else {
    window.location.href = "/find/";
  }
}

/**封面小箭头动画**/
var _coverGif = {
  _init: function() {
    $(".u-arrow-bottom img").css({"top": 0,"opacity": 1});
    _coverGif._foot1();
  },
  _foot1: function() {
    $(".u-arrow-bottom img").animate({
      "top": -10 + "px"
    }, 400, function() {
      $(".u-arrow-bottom img").animate({
        "top": -18 + "px",
        "opacity": 0
      }, 700, function() {
        $(".u-arrow-bottom img").animate({
          "top": 0
        }, 500, function() {
          _coverGif._init();
        });
      });
    });
  }
};
if (_info._coverImageUrl != undefined && _info._coverImageUrl != "") {
  var coverDiv = $("#coverDiv")[0],
    bodyDiv = $(document)[0],
    y = $(window).height(),
    upStartY, upEndY, downStartY, downEndY;
}
/**封面**/
var _coverControl = {
  _upOn: function() {
    coverDiv.addEventListener("touchstart", upStart, false);
    coverDiv.addEventListener("touchmove", upMove, false);
    coverDiv.addEventListener("touchend", upEnd, false);
  },
  _upOff: function() {
    coverDiv.removeEventListener("touchstart", upStart, false);
    coverDiv.removeEventListener("touchmove", upMove, false);
    coverDiv.removeEventListener("touchend", upEnd, false);
  },
  _downOn: function() {
    bodyDiv.addEventListener("touchstart", downStart, false);
    bodyDiv.addEventListener("touchmove", downMove, false);
    bodyDiv.addEventListener("touchend", downEnd, false);
  },
  _downOff: function() {
    bodyDiv.removeEventListener("touchstart", downStart, false);
    bodyDiv.removeEventListener("touchmove", downMove, false);
    bodyDiv.removeEventListener("touchend", downEnd, false);
  },
  _scrollOff: function(event) {
    bodyDiv.removeEventListener('touchstart', bodyScroll(event), false);
    bodyDiv.removeEventListener('touchmove', bodyScroll(event), false);
    bodyDiv.removeEventListener('touchend', bodyScroll(event), false);
  },
  _scrollOn: function(event) {
    bodyDiv.addEventListener('touchstart', bodyScroll(event), false);
    bodyDiv.addEventListener('touchmove', bodyScroll(event), false);
    bodyDiv.addEventListener('touchend', bodyScroll(event), false);
  },
  _init: function() {
	upStartY="";
	upEndY="";
	downStartY="";
	downEndY="";
  }
};
/**浏览器默认事件控制**/
function bodyScroll(event) {
  event.preventDefault();
}
/**封面上拉收起动作**/
function upStart(event) {
  _coverControl._scrollOff(event);
  if ($(coverDiv).css("top") == "0px") {
    var touch = event.touches[0];
    upStartY = touch.pageY;
  }
}

function upMove(event) {
  var touch = event.touches[0];
  upEndY = touch.pageY;
  if (upEndY < upStartY) {
    $("#coverDiv").css("top", upEndY - upStartY + "px");
  }
  //$("#testTxt").html("●upStartY="+upStartY+"<br>●upEndY="+upEndY+"<br>●downStartY="+downStartY+"<br>●downEndY="+downEndY+"<br>●top="+$("#coverDiv").css("top"));
}

function upEnd(event) {
  var y = $(window).height();
  if (upEndY < upStartY) {
    if ((upStartY - upEndY) > 100) {
      $(coverDiv).animate({
        "top": -y + "px"
      }, 300, function() {
        _coverControl._upOff();
        _coverControl._downOn();
        $("body").css({"height": "auto","overflow-y": "auto"});
        _cookie._set(_info._type + _info._id + "ifCover", "no");
        _coverControl._scrollOn(event);
        _coverControl._init();
      });
    } else {
      $(coverDiv).animate({
        "top": 0 + "px"
      }, 300, function(){
    	  _coverControl._init();
      });
    }
  } else {
    $("#coverDiv").css("top", 0 + "px");
    _coverControl._init();
  }
}
/**封面下拉展开动作**/
function downStart(event) {
  var y = $(window).height();
  if ($(coverDiv).css("top") == -y + "px") {
    var touch = event.touches[0];
    downStartY = touch.pageY;
  }
}

function downMove(event) {
  var touch = event.touches[0];
  downEndY = touch.pageY;
  if (downEndY > downStartY) {
    var y = $(window).height();
    if ($("body").scrollTop() == 0) {
      $("body").css({"height": y + "px","overflow-y": "hidden"});
      _coverControl._scrollOff(event);
      $("#coverDiv").css("top", downEndY - downStartY - y + "px");
    } else {
      _coverControl._scrollOn(event);
      $("body").css({"height": "auto","overflow-y": "auto"});
    }
  } else {
    $("body").css({"height": "auto","overflow-y": "auto"});
  }
  //$("#testTxt").html("●upStartY="+upStartY+"<br>●upEndY="+upEndY+"<br>●downStartY="+downStartY+"<br>●downEndY="+downEndY+"<br>●top="+$("#coverDiv").css("top"));
}

function downEnd(event) {
  var y = $(window).height();
  if (downEndY > downStartY) {
    if ((downEndY - downStartY) > 100) {
      $(coverDiv).animate({
        "top": 0
      }, 300, function() {
        _coverControl._downOff();
        _coverControl._upOn();
        $("body").css({"height": y + "px","overflow-y": "hidden"});
        _cookie._set(_info._type + _info._id + "ifCover", "yes");
        _coverControl._scrollOn(event);
        _coverControl._init();
      });
    } else {
      $(coverDiv).animate({"top": -y + "px"}, 300, function(){
    	  _coverControl._scrollOff(event);
    	  _coverControl._init();
      });
    }
  } else {
    $("#coverDiv").css("top", -y + "px");
    _coverControl._init();
  }
}

/**
 * 敏感字校验
 * 生成赞列表、参与列表、评论列表时，校验是否含有敏感字
 * @param str
 * @returns {boolean}
 */
function verifyWord(str) {
  var filterRegex1 = /\+v|\+V|加v|加V|加微/;
  var filterRegex2 = /(.*)(\+|加|v|V|红包|微信|朋友)(.*)[0-9a-zA-Z]{6,}/;
  var filterRegex3 = /(.*)[0-9a-zA-Z]{6,}(.*)(\+|加|v|V|红包|微信|朋友)/;
  if (filterRegex1.test(str)) {
    return false;
  }
  if (filterRegex2.test(str)) {
    return false;
  }
  if (filterRegex3.test(str)) {
    return false;
  }
  return true;
}

var _upLoadtime = { //详情页 控制页面显示 倒计时
  _wait: 60,
  _init: function() {
    if ($("#dt_join_bar").css("bottom") == "0px") {
      $("#loadAfter").animate({
        "opacity": 0,
        "height":"1px"
      }, 500, function(){
      	$("#loadAfter").hide();
    	$("body").css("overflow","auto");
      });
      $(".detail_mainK").animate({
        "opacity": 1
      }, 500, function() {
        $(".content-body,.dt_join_bar,#global_content,#coverDiv,#detail_hudongQ").animate({
          "opacity": 1
        }, 50);
      });
    } else {
      _upLoadtime._wait = _upLoadtime._wait - 1;
      if (_upLoadtime._wait == 1) {
        //console.log("超时了!");
        $("#coverDiv").remove();
        $(".content-body,.dt_join_bar,#global_content,#coverDiv,#detail_hudongQ,.detail_mainK").css({
          "opacity": 1
        });
        $("#loadAfter").animate({
          "opacity": 0,
          "height":"1px"
        }, 500, function(){
        	$("#loadAfter").hide();
        	$("body").css({"height": "auto","overflow-y": "auto"});
        });
      } else {
        setTimeout(function() {
          _upLoadtime._init();
        }, 1000)
      }
    }
  }
};

//TODO 页面初始化设置
$(document).ready(function() {
  //$(".detail_mainK").css("opacity",1);
  //$("#loadAfter").remove();
  _getShopInfo._init();
  if(_fmShezhi == "1"){
	  _file._init();
	  return;
  }else{
	  /*封面设置*/
	  if (_info._coverImageUrl != undefined && _info._coverImageUrl != "") {
		_fm._init();
	    $(window).scroll(function() {
	      if ($("body").scrollTop() == 0) {
	        _coverControl._downOn();
	      } else {
	        _coverControl._downOff();
	      }
	    });
	    var ifCover = _cookie._get(_info._type + _info._id + "ifCover");
	    var y = $(window).height();
	    if (_user._inHudongba() && _user._useAndroid()){
	      setTimeout(function(){var y = $(window).height()},3000);
	    }
	    if ($("body").scrollTop() == 0) {
	      if (ifCover == "" || ifCover == "yes") {
	        //判断封面历史处于打开状态
	    	  $("body").css({"height": y + "px","overflow-y": "hidden"});
	    	  if (_user._inHudongba() && _user._useAndroid()){
	    		setTimeout(function(){
    			  _coverControl._downOff();
		          _coverControl._upOn();
		          y = $(window).height();
		          $("body").css({"height": y + "px","overflow-y": "hidden"});
		          _coverControl._scrollOn(event);
		          _coverControl._init();
	    		},3500);
	    	  }else{
	    		setTimeout(function(){
	    		  _coverControl._downOff();
		          _coverControl._upOn();
		          _coverControl._scrollOn(event);
		          _coverControl._init();
	    		},2500);
	    	  }
	      } else {
	        _coverControl._downOn();
	        $("body").css({"height": "auto","overflow-y": "auto"});
	      }
	    }
	    function orientationChange() {
			switch (window.orientation) {
				case 0:setTimeout(function(){_fm._count();},300);break;
				case -90:setTimeout(function(){_fm._count();},300);break;
				case 90:setTimeout(function(){_fm._count();},300);break;
				case 180:setTimeout(function(){_fm._count();},300);break;
			};
		};
		// 添加事件监听
		addEventListener('load', function() {
			orientationChange();
			window.onorientationchange = orientationChange;
		});
	  }else{
		_file._init();
		$("#coverDiv").remove();
        $(".content-body,.dt_join_bar,#global_content,#coverDiv,#detail_hudongQ,.detail_mainK").css({
          "opacity": 1
        });
        $("#loadAfter").css({"opacity": 0,"height":"1px"});
        $("#loadAfter").hide();
    	$("body").css({"height": "auto","overflow-y": "auto"});
	  }
  }
  _isFocus._init();
  if(_info._shopId!=0 && _info._shopId!=""){
    $("#attent_Btn").css("display","block");
  }
  _upLoadtime._init();
});

var _file = {
  _init: function(){
	  if(_info._type=="party"||_info._type=="article"||_info._type=="vote"){
		$("#dt_content").html(_info._fileContnet);
	  }
	  $(window).bind('orientationchange', _orientationchange);
	  if (_user._inHudongba()) {
	    $(".dt_join_barL").hide();
	    $(".dt_join_barL").width(0);
	    $(".dt_join_barR").css({"margin-bottom": 8 + "px"});
	    $(".top_load").hide();
	    setTimeout(function() {
	      _guess._reset();
	    }, 2000);
	  } else {
	    $("#a_post").attr("target", "_blank");
	    $("#a_detail_right").attr("target", "_blank");
	  }
	  
	  if (_user._inWeixin()) {
	    $("#a_post").attr("href", _link._followMp);
	    $("#info_share").attr("onclick", "");
	    //document.title = "互动吧";
	  }
	  _support._init();
	  _hdbLoad._run(".dt_content_pic img");
	  if(_info._type!="find"){
		  _infoHintsShare._post();
		  _share._init();
		  _like._init();
		  _reviewLoading._init();
		  _reFresh();
		  _postSucess._init();
		  _khDuan._init();
		  _recommend._init();
	  }else{
		  _findLoading._init();
	  }
	  if (_user._useAndroid()) {
	    $(".dt_zan .dt_like .zanWk").css("margin-top", 0 + "px");
	    $(".dt_review_top .dt_review_topR span").css("margin-top", 5 + "px");
	    $(".dt_join_bar_ul_wap li div a p img").css("margin-top", -1 + "px");
	    $(".dt_address_item .addressP").css("background-position", 0 + "px " + 10 + "px");
	    $(".detail_time_attr_join_gray .detail_Joinnum .detail_Joinnum_t").css("background-position", 0 + "px " + 0 + "px");
	    $(".postAfterbtn_l a,.postAfterbtn_r a").css("background-position-y", 1 + "px");
	    $("#dt_list_title_manage").css("line-height", 27 + "px");
	  }
	  if (_user._useAndroid() || _user._useIOs()) {
	    $(".button_r").css("display", "none");
	    $(".button_l").css("width", "100%");
	    $(".postAfterbtn_l").css("margin-right", 15 + "px");
	  }
	
	  $("[v_src]").each(function(){
	      var vsrc=$(this).attr("v_src");
	      $(this).attr("src",vsrc);
	  });
	
	  if (_info._type == "party") {
		  _joinLoading._init();
		  _manage._init();
	
		  if (_user._login()){
		    _joinForm._init('party');
		  }
	  }
	  _listener();
	  _payList._init();
  }
}
//TODO 封面设置
var _fm = {
  _wait: 60,
  _init: function() {
    if (_fm._wait != 0) {
      _fm._wait = _fm._wait - 1;
      if (document.getElementById('coverDiv').dataimg == '1') {
        if (_user._inHudongba() && _user._useAndroid()) {
          if (_fm._wait > 6) {
            _fm._wait = 6;
          } else if (_fm._wait == 5) {
            _coverGif._init();
            _file._init();
          }
        } else {
          _fm._wait = 0;
          _coverGif._init();
          _file._init();
        }
      }
      setTimeout(function() {
        _fm._count();
        _fm._init();
      }, 1000);
    }
  },
  _count: function() {
    var w = $("body").width(),
      y = $(window).height();
    if (y / w > 1.5) {
      $("#fm").css({"height": y + "px","width": y * 2 / 3 + "px","margin-left": (w - y * 2 / 3) / 2 + "px","margin-top": 0 + "px"});
    } else {
      $("#fm").css({"width": w + "px","height": w * 3 / 2 + "px","margin-top": (y - w * 3 / 2) / 2 + "px","margin-left": 0 + "px"});
    }
    $("#coverDiv").css({"width": w,"height": y});
    var ifCover = _cookie._get(_info._type + _info._id + "ifCover");
    var y = $(window).height();
    if ($("body").scrollTop() == 0) {
      if (ifCover == "" || ifCover == "yes") {
        $("#coverDiv").css("top", 0 + "px");
      } else {
        $("#coverDiv").css("top", -y + "px");
      }
    } else {
      $("#coverDiv").css("top", -y + "px");
    }
  }
};

$(".tc_c2 .join_box_Xq ul li,.danX_p,#ul_join_property li").click(function() {
  $(this).addClass("thisOver").siblings().removeClass("thisOver");
});
$(".duoX_p").click(function() {
  $(this).toggleClass("thisOver");
});
$(".danX_p,.duoX_p").each(function() {
  var x = $(this).children("strong").html();
  x = _._len(x);
  if (x > 10) {
    $(this).parent("div").children("p").css("width", "100%");
  }
});

window.onload = function() {
  if (_user._inHudongba()) {
    if (_user._useIOs() && appInfo.app_v < 3.0) {
      $(".tsUp").slideDown(1000);
    }
    if (_user._useAndroid() && appInfo.app_v < 3.11) {
      $(".tsUp").slideDown(1000);
    }
  }

  if (_t._get(_info._id + "_" + _user._id() + "_joinSuccess") == "1") {
    _t._set(_info._id + "_" + _user._id() + "_joinSuccess", "0");
    var _item = _t._get(_info._id + "_" + _user._id() + "_item");
    _t._set(_info._id + "_" + _user._id() + "_item", "");
    dataForShare.title = "我报名了《" + dataForShare.title + "》，你也来看看吧"; //2015.06.24 邀请码功能已不再使用
    $("#dt_join_menu_bg .dt_join_top").unbind("click");
    _joinBeforeLogin._mark("");
    _joinBox._hide();
    _backToRefresh._mark();
    _joinBox._clear();
    _scroollTop._top(".dt_join_menu_bg", 500, 200);
    _joinAfter._show("tc_chengNopay");
    if (_info._verify == "0") {
      if (_user._inWeixin()) {
        onBridgeReady_new();
      }
    }
    if (_joinForm._toVerifyMobile(_joinForm._mobile)) {
      _info._verifyMobile = _info._verifyMobile + _joinForm._mobile + "|";
    }
    if (_user._inHudongba()) {
        var _url = _api3._joinQr + "?user_id=" + _user._id() + "&info_id=" + _info._id + "&info_type=" + _info._type;
        $("#join_qr_img,#join_qr_img8").attr("src", _url);
        $("#join_qr_img,#join_qr_img8").bind("error", function() {
          if ($("#tc_2weima").css("display") == "none") {
            return;
          }
          _joinQr._hide();
          _toast._show("网络错误，请稍后重试");
        });
      }
  }
};

(function() {
  var lastTime = 0;
  var vendors = ['webkit', 'moz'];
  for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
    window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
    window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] ||
      window[vendors[x] + 'CancelRequestAnimationFrame'];
  }
  if (!window.requestAnimationFrame) {
    window.requestAnimationFrame = function(callback, element) {
      var currTime = new Date().getTime();
      var timeToCall = Math.max(0, 16.7 - (currTime - lastTime));
      var id = window.setTimeout(function() {
        callback(currTime + timeToCall);
      }, timeToCall);
      lastTime = currTime + timeToCall;
      return id;
    };
  }
  if (!window.cancelAnimationFrame) {
    window.cancelAnimationFrame = function(id) {
      clearTimeout(id);
    };
  }
}());
var _activiType = { //活动类型选择
  _open: false,
  _id: "",
  _init: function() {
    $(".activity_type_tc_ul").css({"max-height": $(window).height() - 40 + "px"});
    if (_activiType._open == false) {
      _tc._hide("activity_select_tc");
      _tc._show("activity_type_tc");
      _activiType._open == true;
    } else {
      _tc._hide("activity_type_tc");
      _activiType._open == false;
    }
  },
  _select: function(id, name) {
    $(".re_top_attr").html(name);
    $(".re_top_attr").attr("id", "type_top_"+id);
    _tc._hide("activity_type_tc");
    _activiSelect._post();
  },
  _center: function() {
    var _top = _._zero(_._client().bh - $("#" + _activiType._id).outerHeight()) / 2 + "px";
    var _left = _._zero(_._client().bw - $("#" + _activiType._id).outerWidth()) / 2 + "px";
    $("#" + _activiType._id).css({"left": _left,"top": _top,"z-index": "1001","position": "fixed"});
  },
  _show: function(id) {
    _activiType._id = id;
    $("#" + _activiType._id).show();
    _cover._show("cover2");
    $("#cover2").bind("click", _activiType._hide);
    _activiType._center();
    $(window).bind("resize", _activiType._center);
    _cover._show("cover2");
    $(".find_top .c a").addClass("thisOver");
    _activiType._open == true;
  },
  _hide: function() {
    _cover._hide("cover2");
    $("#" + _activiType._id).hide();
    $(".find_top .c a").removeClass("thisOver");
    _activiType._open == false;
  }
};

var _activiSelect = { //筛选
  _id: "",
  _area_id:$("#area_id").find(".thisOver").attr("id"),
  _area_name:$("#area_id").find(".thisOver").html(),
  _start_date:$("#start_date").find(".thisOver").html(),
  _is_charge:$("#is_charge").find(".thisOver").attr("id"),
  _pay_type:$("#is_charge").find(".thisOver").html(),
  _category_id:$(".re_top_attr").attr("id"),
  _category_name:$(".re_top_attr").html(),
  _comm: function(){
    _activiSelect._area_id = $("#area_id").find(".thisOver").attr("id");
    _activiSelect._area_name = $("#area_id").find(".thisOver").html();
    _activiSelect._start_date = $("#start_date").find(".thisOver").html();
    _activiSelect._is_charge = $("#is_charge").find(".thisOver").attr("id");
    _activiSelect._pay_type = $("#is_charge").find(".thisOver").html();
    _activiSelect._category_id = $("#party_type").find(".thisOver").attr("id");
    _activiSelect._category_name = $("#party_type").find(".thisOver").html();
  },
  _init: function(type) {
	if(type=="type"){
	  $(".sclect_ul").hide();
	  $("#party_type").show();
	  _tc._show("activity_select_tc");
	}else if(type=="time"){
	  $(".sclect_ul").hide();
	  $("#start_date").show();
	  _tc._show("activity_select_tc");
	}else if(type=="pay"){
	  $(".sclect_ul").hide();
	  $("#is_charge").show();
	  _tc._show("activity_select_tc");
    }else if(type=="area"){
  	  $(".sclect_ul").hide();
	  $("#area_id").show();
	  _tc._show("activity_select_tc");
    }
  },
  _center: function() {
    var _top = _._zero(_._client().bh - $("#" + _activiSelect._id).outerHeight()) / 2 + "px";
    var _left = _._zero(_._client().bw - $("#" + _activiSelect._id).outerWidth()) / 2 + "px";
    $("#" + _activiSelect._id).css({"left": _left,"top": _top,"z-index": "1001","position": "fixed"});
  },
  _show: function(id) {
    _activiSelect._id = id;
    $("#" + _activiSelect._id).show();
    _cover._show("cover2");
    $("#cover2").bind("click", _activiSelect._hide);
    _activiType._center();
    $(window).bind("resize", _activiSelect._center);
    _cover._show("cover2");
    _activiSelect._open == true;
    var _category_id = $("#category_id span").attr("id");
    if (_category_id == 139 || _category_id == 140) {
      $("#info_charge").hide(); //如果是精选好文或者是投票则隐藏收费项
      $("#is_charge").hide();
    } else {
      $("#info_charge").show();
      $("#is_charge").show();
    }
  },
  _hide: function() {
    _cover._hide("cover2");
    $("#" + _activiSelect._id).hide();
    _activiSelect._open == false;
  },
  _reset: function() { //重置
    $(".sclect_ul li a").removeClass("thisOver");
    $("#area_id li a:first,#start_date li a:first,#is_charge li a:first").addClass("thisOver");
  },
  _ok: function(json, code) {
    _loading._hide();
    if (code != 200) {
	  return;
	}
    var titleName = _activiSelect._area_name + _activiSelect._category_name + "活动_互动吧-最大的活动发布平台";
    dataForShare.title = titleName.replace("_", " ");
    $(document).attr("title", titleName);
    var _html = _findLoading._ok(json, code);
    _findLoading._index = 2;
    $(".activity_ul").html(_html);
    if(_activiSelect._start_date=="不限"){_activiSelect._start_date = "时间"}
    if(_activiSelect._pay_type=="全部"){_activiSelect._pay_type="费用"}
    $(".find_activity_type_category").find("span").html(_activiSelect._category_name);
    $(".find_activity_type_time").find("span").html(_activiSelect._start_date);
    $(".find_activity_type_pay").find("span").html(_activiSelect._pay_type);
    $(".re_top_attr").html(_activiSelect._area_name);
    _hdbLoad._run(".dt_content_pic img");
  },
  _post: function(id) {
	$("#"+id).parent().parent().children("li").children("a").attr("class","");
	$("#"+id).attr("class","thisOver");
	_activiSelect._comm();
    _findLoading._init(); //重新绑定滚动条事件解决重新查询时不能实现瀑布加载
    _tc._hide("activity_select_tc");
    _loading._show("加载中");
    _$(_api3._recommendList, "page_size=20&page_num=1&app_hdb_id=" + _findLoading._app_hdb_id
    		+ "&area_id=" + _activiSelect._area_id.replace(/activityAttr_/g, '')
    		+ "&area_name=" + _activiSelect._area_name
    		+ "&start_date=" + _activiSelect._start_date
    		+ "&is_charge=" + _activiSelect._is_charge.replace(/pay_/g, '').replace(/qb/g, '')
    		+ "&category_id=" + _activiSelect._category_id
    		+ "&category_name=" + _activiSelect._category_name, _activiSelect._ok);
  }
};

var _findLoading = {
  _app_hdb_id: _info._app_hdb_id,
  _index: 2,
  _flag: false,
  _trigger: function() {
    if (_findLoading._flag == false && _._client().h - _._client().bh - 100 <= _._scroll().y && _._client().h > 1000) {
      _findLoading._post();
    }
  },
  _init: function() {
    $("#div_last").show();
    if (_info._next_state == "0") {
      _loadingBottom._noMore("已全部加载", "loading_bottom_find");
      return;
    }
    _loadingBottom._initTime("加载更多", _findLoading._post, "loading_bottom_find");
    setTimeout(_findLoading._trigger, 50);
    $(window).bind("scroll", _findLoading._trigger);
  },
  _post: function() {
	_activiSelect._comm();
    if (_findLoading._flag == true) {
      return;
    }
    _findLoading._flag = true;
    _loadingBottom._loading("loading_bottom_find");
    _$(_api3._recommendList, "page_size=20&page_num=" + _findLoading._index 
    	+ "&app_hdb_id=" + _findLoading._app_hdb_id 
    	+ "&area_id=" + _activiSelect._area_id.replace(/activityAttr_/g, '')
		+ "&area_name=" + _activiSelect._area_name
		+ "&start_date=" + _activiSelect._start_date
		+ "&is_charge=" + _activiSelect._is_charge.replace(/pay_/g, '').replace(/qb/g, '')
		+ "&category_id=" + _activiSelect._category_id
		+ "&category_name=" + _activiSelect._category_name, _findLoading._appendul);
  },
  _ok: function(json, code) {
    var _html = "";
    _loadingBottom._hide("loading_bottom_find");
    if (code != 200 || (code == 200 && json.state.toString() != "0")) {
      _loadingBottom._initTime("网络错误，点击重新加载", _findLoading._post, "loading_bottom_find");
      return _html;
    }
    var _data = json.info_list,
      _len = _data.length;
    if (json.next_state.toString() == "0") {
      _loadingBottom._noMore("已全部加载", "loading_bottom_find");
      $(window).unbind("scroll");
    } else {
      _findLoading._flag = false;
      _findLoading._index++;
      _loadingBottom._initTime("加载更多", _findLoading._post, "loading_bottom_find");
    }
    if (_len == 0) {
      return _html;
    }
    var arrayObj = new Array();
    var lis = $(".activity_ul").children("li");
    $.each(lis, function(i, item) { //校验是否有重复数据
      var lid = $(lis[i]).attr("id");
      arrayObj.push(lid);
    });


    for (var i = 0; i < _len; i++) {
      var _d = _data[i];
      if (arrayObj.indexOf(_d.info_type + _d.info_id) != 0) {
        _html += _findLoading._addItem(_d.info_id, _d.info_type, _d.info_title, _d.is_charge, _d.info_image_url, _d.info_start_date, _d.info_area_name, _d.info_count, _d.info_join_total, _d.remain_num);
      }
    }
    return _html;
  },
  _appendul: function(json, code) {
    var _html = _findLoading._ok(json, code);
    $(".activity_ul").append(_html);
    setTimeout(function() {
      _hdbLoad._run(".activity_img");
    }, 500);
    _findLoading._lih();
  },
  _addItem: function(info_id, info_type, info_title, is_charge, info_image_url, info_start_date, info_area_name, info_count, info_join_total, remain_num) {
    var _count = 0;
    var _item = "<li class=\"activity_li\" id=\"" + info_type + info_id + " \">" + "<a class=\"activity_A img\" href=\"" + _info._domain + info_type + "/" + info_id + "-WapFind.html\"  ontouchstart=\"\" >";
    if (info_image_url != "") {
      _item += "<div class=\"dt_content_pic\"><img class=\"activity_img\" data-src=\" " + info_image_url + " \" src=\"" + _info._img1_url + "/static_v4/images/other/face_default_100.png\" alt=\"\" /></div>";
      _item += "<div class=\"activity_K\">";
    } else {
      _item += "<div class=\"activity_K\" style=\"margin-right: 20px\">";
    }
    _item += "<div class=\"act_wz_t\"><p>" + toTXT(info_title) + "</p></div>";

    if (info_type = "party") {
      _item += "<div class=\"act_wz_c\">";
      if (info_start_date != "") {
        _item += "<p class=\"act_c_time\">" + info_start_date + "</p>";
      }
      if (is_charge == 1) {
        _item += "<p class=\"act_c_pay\"><span>收费</span></p>";
      }
      _item += "</div>" + "<div class=\"act_wz_b\">";
      _item += "<p class=\"act_b_join\">";
      if (remain_num != null && remain_num > 0)
        _item += "仅剩<span class=\"act_b_join_num\">" + remain_num + "</span>个名额";
      else if (remain_num != null && remain_num <= 0) {
        _item += "报名人数已满";
      } else {
        if (info_count != null && info_count < 10) {
          if (info_join_total != null && info_join_total > 0) {
            _item += "限<span class=\"act_b_join_num\">" + info_join_total + "</span>名额";
          } else {
            _item += "不限名额";
          }
        } else {
          if (info_count.length >= 7) {
            _item += "<span class=\"act_b_join_num\">" + info_count.substr(0, info_count.length - 4) + "</span>万+ 报名";
          } else {
            _item += "<span class=\"act_b_join_num\">" + info_count + "</span> 报名";
          }
        }
      }
      _item += "</p>";
      if (info_area_name != "") {
        _item += "<p class=\"act_b_addr\">" + info_area_name + "</p>";
      }
      _item += "</div>";
    }
    _item += "</div></a></li>";
    return _item;
  },
  _lih: function() {
    $(".dt_content_pic").each(function() {
      var h = $(this).parent("a").height();
      if (h < 110) {
        h = 110;
      }
      $(this).css({"top": (h - 110) / 2 + "px"});
    });
  }
};

//邀请码
var _partyInvite = {
  _post: function() {
    var _code = _._trim($("#dt_invite_form_code").val());
    if (_code == "") {
      _toast._show("请输入邀请码");
      return;
    }
    if (_._len(_code) > 30) {
      _toast._show("邀请码不正确");
      return;
    }
    _loading._show("请稍候");
    _$(_api3._checkInviteCode, "info_id=" + _info._id + "&info_type=" + _info._type + "&code=" + _._encode(_code), _partyInvite._ok);
  },
  _ok: function(json, code) {
    _loading._hide();
    if (code != 200) {
      return;
    }
    _g(location.href.toString());
  }
};
//投票
var _vote={
  _loginMark:function(value){
        _t._set("vote_before_login_"+_info._type+"_"+_info._id,value);
    },
  _selArr:[],
  _scaleArr:[],
   _post:function(){
      var _selected=_option._getSelected();
      if(_selected!="" && !_user._inHudongba()){_option._setTemp(_selected);}
      if(_info._power=="1"){_toast._show("该投票需要验证邮箱后才能参与");return;}
      if(_selected==""){
          _scroollTop._top(".dt_vote");
        _toast._show("你没有作出任何选择");        
        return;
      }
      if(_info._kind==1&&_selected.indexOf(",")>0){
          _toast._show("单选只能选择一个选项");       
        return;
      }
      if(_info._kind==0&&_info._count!=0&&_selected.split(",").length>_info._count){
         _toast._show("本投票最多只能选"+_info._count+"项");       
        return;
      }
      if(!_user._login()){
         if(!_user._inHudongba()){_vote._loginMark("1");}
        _user._toLogin('Vote');
        return;
      }
      _loading._show("请稍候");
      _$(_api3._vote,"h_share_uid="+_info._shareUid+"&vote_id="+_info._id+"&options="+_selected,_vote._ok);
   },
   _ok:function(json,code){
      _loading._hide();
    if(code!=200){return;}
    if(json.state.toString()!="0"){
      _toast._show(json.error,function(){
        _user._error(json.state,"vote");
      });
      return;
    }
    _option._setTemp("");
    _backToRefresh._mark();
    _vote._loginMark("");

       var _totalCount=0,
               _data=json.vote_option,
               _len=_data.length,
               _joinOptionIds=json.join_option_ids,
               _joinOptionCount = json.join_option_count,
               _isUseMq = json.is_use_mq;

       var selectedIdArray = new Array();
       selectedIdArray = _joinOptionIds.split(",");

       for(var i=0;i<_len;i++){
           _totalCount+=parseInt(_data[i].counts);

           if(_isUseMq == "1"){

               if(selectedIdArray.indexOf(_data[i].id)>-1){
                   _data[i].counts = _data[i].counts + 1;
               }
           }
       }

       if(_isUseMq == "1"){
           _totalCount += _joinOptionCount;
       }

    $("#span_join_count").html(_totalCount);
    if(_info._kind==0){$("#dt_vote_main").attr("class","dt_vote_main duoXuanJg");}else{$("#dt_vote_main").attr("class","dt_vote_main danXuanJg");}
    var _html ="";
    for(var ii=0;ii<_len;ii++){
      _html+= _vote._addItem(_data[ii].id,_data[ii].option,_data[ii].counts,_totalCount,_joinOptionIds);
    }
    if(_._trim($("#dt_vote_result").html())!=""){$("#vote_result").show();}
    $("#span_decrip").hide();
    $("#dt_vote_main").html(_html);
    
    
    for(var i=0,_len=_vote._selArr.length;i<_len;i++){
        var _no = 100-_vote._scaleArr[i];
      $("#yes"+_vote._selArr[i]).animate({width:_vote._scaleArr[i]+"%"}, "slow");
    }
     
    $("#dt_join_bar_title").html("<a href=\"javascript:void(0)\" ontouchstart=\"\" class=\"btn_style2\"> <p class=\"bar_img\"><span><img class=\"dt_join_bar_icon\" src=\""+_info._img1Url+"/static_v4/images/detail/xd_icon_4.png\" alt=\"\" /></span></p> <p class=\"bar_tit\"><span>已投票</span></p></a>");
    $("#dt_join_bar_title_mb").html("<a href=\"javascript:void(0)\" ontouchstart=\"\" class=\"btn_style2\"> <p class=\"bar_img\"><span><img class=\"dt_join_bar_icon\" src=\""+_info._img1Url+"/static_v4/images/detail/xd_icon_4.png\" alt=\"\" /></span></p> <p class=\"bar_tit\"><span>已投票</span></p></a>");
    dataForShare.title="赞哦！我参加了《"+dataForShare.title+"》投票，你也来试试";
    if(_user._inWeixin()){onBridgeReady_new();}
    setTimeout(function(){_vote._sucess();},1600);
    $("#a_post").attr("href","/post??hdb_from=WapEnrollVote");
   },
   _addItem:function(id,option,count,totalCount,joinOptionIds){
       var _scale;

       if(totalCount == 0){
           _scale = 0.0;
       }else{
           _scale = Number(Math.round(count/totalCount*10000)/100).toFixed(1);
       }

    var _userCk = ""
    if((","+joinOptionIds+",").indexOf(","+id+",")!=-1){
      _userCk = "thisOver";
    }   
    _vote._selArr.push(id);
    _vote._scaleArr.push(_scale);     
    var _item = "<li class=\"dt_vote_list "+_userCk+"\">"
             + "<div class=\"dt_vote_jg\">"
             +"     <div class=\"dt_vote_list_icon\"><span></span></div>"
             +"     <div class=\"dt_vote_list_title\"><a class=\"font03\" href=\"javascript:void(0);\">"+option+"</a></div>"
             +"     <div class=\"dt_vote_jg_num\"><p class=\"font04\">"+count+"票 "+_scale+"%</p></div>"
             +"   </div>"
             +"   <div class=\"jinduTiao\">"
         +"   <div id=\"yes"+id+"\" style=\"width: 0%;\" class=\"dt_list_item_vote_scale_yes vote_scale_yes\"></div>"
         +"   </div>"
             +" </li>";
  return _item;
   },
   _sucess:function(){
      $(".baoSuccess p").html("投票成功");
        $("#tc_chengNopay .bmTs_c").hide();
      _joinAfter._show("tc_chengNopay");
   }
};
//投票设置
var funParabola = function(element, target, options) {
  var defaults = {
    speed: 166.67,
    curvature: 0.001,
    progress: function() {},
    complete: function() {}
  };
  var params = {};
  options = options || {};
  for (var key in defaults) {
    params[key] = options[key] || defaults[key];
  }
  var exports = {
    mark: function() {
      return this;
    },
    position: function() {
      return this;
    },
    move: function() {
      return this;
    },
    init: function() {
      return this;
    }
  };
  var moveStyle = "margin",
    testDiv = document.createElement("div");
  if ("oninput" in testDiv) {
    ["", "ms", "webkit"].forEach(function(prefix) {
      var transform = prefix + (prefix ? "T" : "t") + "ransform";
      if (transform in testDiv.style) {
        moveStyle = transform;
      }
    });
  }
  var a = params.curvature,
    b = 0,
    c = 0;
  var flagMove = true;
  if (element && target && element.nodeType == 1 && target.nodeType == 1) {
    var rectElement = {},
      rectTarget = {};
    var centerElement = {},
      centerTarget = {};
    var coordElement = {},
      coordTarget = {};
    exports.mark = function() {
      if (flagMove == false) return this;
      if (typeof coordElement.x == "undefined") this.position();
      element.setAttribute("data-center", [coordElement.x, coordElement.y].join());
      target.setAttribute("data-center", [coordTarget.x, coordTarget.y].join());
      return this;
    };
    exports.position = function() {
      if (flagMove == false) return this;
      var scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft,
        scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      if (moveStyle == "margin") {
        element.style.marginLeft = element.style.marginTop = "0px";
      } else {
        element.style[moveStyle] = "translate(0, 0)";
      }
      rectElement = element.getBoundingClientRect();
      rectTarget = target.getBoundingClientRect();
      centerElement = {
        x: rectElement.left + (rectElement.right - rectElement.left) / 2 + scrollLeft,
        y: rectElement.top + (rectElement.bottom - rectElement.top) / 2 + scrollTop
      };
      centerTarget = {
        x: rectTarget.left + (rectTarget.right - rectTarget.left) / 2 + scrollLeft,
        y: rectTarget.top + (rectTarget.bottom - rectTarget.top) / 2 + scrollTop
      };
      coordElement = {
        x: 0,
        y: 0
      };
      coordTarget = {
        x: -1 * (centerElement.x - centerTarget.x),
        y: -1 * (centerElement.y - centerTarget.y)
      };
      b = (coordTarget.y - a * coordTarget.x * coordTarget.x) / coordTarget.x;
      return this;
    };
    exports.move = function() {
      if (flagMove == false) return this;
      var startx = 0,
        rate = coordTarget.x > 0 ? 1 : -1;
      var step = function() {
        var tangent = 2 * a * startx + b;
        startx = startx + rate * Math.sqrt(params.speed / (tangent * tangent + 1));
        if ((rate == 1 && startx > coordTarget.x) || (rate == -1 && startx < coordTarget.x)) {
          startx = coordTarget.x;
        }
        var x = startx,
          y = a * x * x + b * x;
        element.setAttribute("data-center", [Math.round(x), Math.round(y)].join());
        if (moveStyle == "margin") {
          element.style.marginLeft = x + "px";
          element.style.marginTop = y + "px";
        } else {
          element.style[moveStyle] = "translate(" + [x + "px", y + "px"].join() + ")";
        }
        if (startx !== coordTarget.x) {
          params.progress(x, y);
          window.requestAnimationFrame(step);
        } else {
          params.complete();
          flagMove = true;
        }
      };
      window.requestAnimationFrame(step);
      flagMove = false;
      return this;
    };
    exports.init = function() {
      this.position().mark().move();
    };
  }
  return exports;
};
//投票设置
var _option = {
  _shan: true,
  _getSelected: function() {
    var _selected = "";
    $("li[class='dt_vote_list thisOver']").each(function() {
      _selected += "," + $(this).attr("optionid");
    });
    _selected = _selected.replace(/^\,/g, "");
    return _selected;
  },
  _click: function(obj, type) {
    var _crruentClass = $(obj).attr("class");
    if (_crruentClass.indexOf("thisOver") == -1) {
      if (_info._kind == 0 && _info._count != 0 && $("#dt_vote_main li[class$='thisOver']").length >= _info._count) {
        _toast._show("本投票最多只能选" + _info._count + "项");
        return;
      }
    }
    $(obj).attr("class", "dt_vote_list " + (_crruentClass.indexOf("thisOver") == -1 ? "thisOver" : ""));
    if (type == 'single') {
      $(obj).siblings().removeClass("thisOver");
    }
    if (!_postSucess._fromApp() && _info.state != "0") {
      if ($(obj).attr("class") == "dt_vote_list thisOver") {
        _option._move(obj);
      }
    }
  },
  _getTemp: function() {
    if (_t._get("vote_before_login_" + _info._type + "_" + _info._id) != "1") {
      return;
    }
    var _joinOptionIds = _t._get("join_vote_" + _info._id);
    if (_joinOptionIds != "" && _info._join != "1" && _info._lock == false) {
      $("li[class^='dt_vote_list']").each(function() {
        var _id = $(this).attr("optionid");
        if (("," + _joinOptionIds + ",").indexOf("," + _id + ",") != -1) {
          $(this).addClass("thisOver");
        }
      });
      setTimeout(function() {
        _scroollTop._top(".dt_vote");
        _vote._post();
      }, 500);
    }
  },
  _setTemp: function(value) {
    _t._set("join_vote_" + _info._id, value);
  },
  _move: function(obj) {
    $("#flyItem").show();
    var eleFlyElement = document.querySelector("#flyItem"),
      eleShopCart = document.querySelector("#dt_join_bar_title");
    var myParabola = funParabola(eleFlyElement, eleShopCart, {
      speed: 400,
      curvature: 0.002,
      complete: function() {
        $("#flyItem").hide();
        $(".zTai01").animate({top: "-20px"}, 50);
        setTimeout(function() {
          $(".zTai01").animate({top: "0"}, 100);
        });
      }
    });
    $("#flyItem").css({"top":$(obj).offset().top + "px","visibility":"visible"});
    myParabola.position().move();
  }
};

//Html结构转字符串形式显示 支持<br>换行
function ToHtmlString(htmlStr) {
  return toTXT(htmlStr).replace(/\&lt\;br[\&ensp\;|\&emsp\;]*[\/]?\&gt\;|\r\n|\n/g, "<br/>");
}
//Html结构转字符串形式显示
function toTXT(str) {
  var RexStr = /\<|\>|\"|\'|\&|　| /g;
  str = str.replace(RexStr,
    function(MatchStr) {
      switch (MatchStr) {
        case "<":return "&lt;";break;
        case ">":return "&gt;";break;
        case "\"":return "&quot;";break;
        case "'":return "&#39;";break;
        case "&":return "&amp;";break;
        case " ":return "&ensp;";break;
        case "　":return "&emsp;";break;
        default:break;
      }
    });
  return str;
}

var _payList = {//wap端报名收费项 数量变更
  _init:function(){
	$(".tc_c_feiLi li .feiyong_l .joinNum b").each(function(){
      if($(this).html()=="0"){
		$(this).parent(".joinNum").html("已卖完");
	  }
	});
  },
  _add:function(){
    if($(".tc_c_feiLi li").length!="0" && $(".tc_c_feiLi .thisOver .feiyong_l .joinNum").html()=="已卖完"){
    	$(".tc_c_feiLi .thisOver .feiyong_l .joinNum").html("剩余：<b>1</b>");
    	var _index = $(".tc_c_feiLi .thisOver").index();
    	$(".detail_pay_list_ul li").eq(_index).find(".detail_pay_list_b").html('剩余<span class="num">1</span>个名额');
    }else if($(".tc_c_feiLi").length!="0" && $(".tc_c_feiLi .thisOver .feiyong_l .joinNum b").length!="0"){
      $(".tc_c_feiLi .thisOver .feiyong_l .joinNum b").html(parseInt($(".tc_c_feiLi .thisOver .feiyong_l .joinNum b").html())+1);
      var _index = $(".tc_c_feiLi .thisOver").index();
      $(".detail_pay_list_ul li").eq(_index).find(".num").html(parseInt($(".detail_pay_list_ul li").eq(_index).find(".num").html())+1);
    }
  },
  _less:function(){
    if($(".tc_c_feiLi li").length!="0" && $(".tc_c_feiLi .thisOver .feiyong_l .joinNum b").length!="0"){
      $(".tc_c_feiLi .thisOver .feiyong_l .joinNum b").html(parseInt($(".tc_c_feiLi .thisOver .feiyong_l .joinNum b").html())-1);
      var _index = $(".tc_c_feiLi .thisOver").index();
      $(".detail_pay_list_ul li").eq(_index).find(".num").html(parseInt($(".detail_pay_list_ul li").eq(_index).find(".num").html())-1);
      if($(".tc_c_feiLi .thisOver .feiyong_l .joinNum b").html()=="0"){
      	$(".tc_c_feiLi .thisOver .feiyong_l .joinNum").html("已卖完");
      	var _index = $(".tc_c_feiLi .thisOver").index();
      	$(".detail_pay_list_ul li").eq(_index).find(".detail_pay_list_b").html('已卖完');
      }
    }
  }
}

//关注
var _isFocus = {
  _init:function(){
//	  if(_t._get("focusLogin")=="no"&&_info._isFocus!=1&&document.referrer.indexOf('login')!=-1){
//		  setTimeout(function() {
//			  _isFocus._add();
//          }, 2000);
//	  }
  },
  _add:function(){
    if(!_user._login()){
		//_t._set("focusLogin","no");
	    _user._toLogin();
	    return false;
	}
    var _shopId36 = _info._shopId.replace(/\,/g, '');
    _$(_api3._shopAttent, "focus_type=1&focus_shop_id=" + _shopId36, _isFocus._addok);
  },
  _addok: function(json, code) {
    if (code != 200) {
      _toast._show("关注失败!");
      return;
    }
    if(json.is_update==0){
		$(".focus_Cz").html('<a id="attent_Btn" href="javascript:void(0)">已关注</a>');
	    if(_user._inHudongba()){
	      _toast._show("关注成功!");

          //触发app
          HudongbaJsBridge["focusShop"](_info._shopId, json.focus_type);

	    }else{
	      _tc._show('tc_attentOk');
	    }
	    //_t._set("focusLogin","");
    }else{
    	_toast._show("关注失败!");
    }
    
  }
}

var _getShopInfo = {
    _init : function(){
        _$(_api3._shopInfo, "user_id=" + _info._postUid, _getShopInfo._getOk)
    },
    _getOk : function(obj){
        var user_name = obj.user_name;
        var user_desc = obj.user_desc;
        var user_pic = obj.user_pic;
        if(user_desc == "" || user_desc == "这里是个人简介!"){
            user_desc = "TA组织活动太忙，还没腾出空写简介";
        }
        if(user_pic!=""){
        	$(".detail_attent_pic a,.userPicA a").html("<img src='"+user_pic+"'/>");
        }else{
        	$(".detail_attent_pic a,.userPicA a").html("<img src='" + _imgCdn + "/static_v4/images/other/face_default_200.png'/>");
        }
        $(".detail_attent_Name p a,#subinfo_name").html(user_name);
        $(".detail_attent_con p").html(user_desc);
    }
};
